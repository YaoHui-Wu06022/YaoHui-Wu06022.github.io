<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ROS2理论 | がんばろう</title><meta name="author" content="今天睡够了吗"><meta name="copyright" content="今天睡够了吗"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="模板VScode配置模板 cpp： 1234567891011121314151617181920212223242526272829303132333435363738394041{  &quot;ROS2 C++ Node Template&quot;: {    &quot;prefix&quot;: &quot;ros2cpp&quot;,    &quot;body&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="ROS2理论">
<meta property="og:url" content="http://yhblogs.cn/posts/3894864178.html">
<meta property="og:site_name" content="がんばろう">
<meta property="og:description" content="模板VScode配置模板 cpp： 1234567891011121314151617181920212223242526272829303132333435363738394041{  &quot;ROS2 C++ Node Template&quot;: {    &quot;prefix&quot;: &quot;ros2cpp&quot;,    &quot;body&amp;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/wallhaven-5g22q5_1920x1080_compressed.png">
<meta property="article:published_time" content="2025-06-30T15:45:57.000Z">
<meta property="article:modified_time" content="2025-11-01T15:04:06.749Z">
<meta property="article:author" content="今天睡够了吗">
<meta property="article:tag" content="🤖ROS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/wallhaven-5g22q5_1920x1080_compressed.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yhblogs.cn/posts/3894864178.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ROS2理论',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-11-01 15:04:06'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="//at.alicdn.com/t/font_3319458_ks437t3n4r.css"><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/b_2a1aef95f351a5f7ef72eb81e6838fd6.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">75</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-rili"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="がんばろう"><img class="site-icon" src="/img/favicon.png"><span class="site-name">がんばろう</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont icon-shouye"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-rili"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont icon-biaoqian"></i><span> 标签</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">ROS2理论</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-06-30T15:45:57.000Z" title="发表于 2025-06-30 15:45:57">2025-06-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">25.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>101分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ROS2理论"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>VScode配置模板</p>
<p>cpp：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"ROS2 C++ Node Template"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"prefix"</span><span class="punctuation">:</span> <span class="string">"ros2cpp"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"body"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">"/*"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  需求:"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  步骤:"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"    1.包含头文件；"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"    2.初始化 ROS2 客户端；"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"    3.定义节点类；"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"    "</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"    4.调用spin函数,并传入节点对象指针;"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"    5.释放资源。"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"*/"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"// 1.包含头文件；"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"#include \"rclcpp/rclcpp.hpp\""</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"// 3.自定义节点类"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"class ${1:MyNode}: public rclcpp::Node{ "</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"public:"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"    $1():Node(\"mynode_node_cpp\"){  // 节点名称一般小写"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"        RCLCPP_INFO(this-&gt;get_logger(),\"创建成功!\");"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"    }"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"};"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"int main(int argc, char ** argv)"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"{"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  // 2.初始化 ROS2 客户端；"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  rclcpp::init(argc,argv);"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  // 4.调用spin函数,并传入节点类对象;"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  rclcpp::spin(std::make_shared&lt;$1&gt;()); "</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  // 5.释放资源。"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  rclcpp::shutdown();"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"  return 0;"</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">"}"</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"description"</span><span class="punctuation">:</span> <span class="string">"A cpp file template"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>launch.py：</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"ROS2 Launch Template"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"prefix"</span><span class="punctuation">:</span> <span class="string">"ros2_launch"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"body"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">"from launch import LaunchDescription"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"from launch_ros.actions import Node"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"def generate_launch_description():"</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">""</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">"    return LaunchDescription([])"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"description"</span><span class="punctuation">:</span> <span class="string">"A template for ROS2 launch files"</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>在ROS2中：</p>
<ul>
<li>节点创建方法设为public</li>
<li>内部组件(publisher/subscriber等)设为private</li>
</ul>
<p>ROS 组件通常加下划线后缀表示成员变量(client_)，节点实例常用简单名称表示主要对象(client)</p>
<p><strong>常见函数：</strong></p>
<p><code>std::bind(&amp;MyNode::Fuc,this,_[i])</code>绑定成员函数</p>
<ul>
<li>第一个参数表示对象的成员函数的指针 </li>
<li>第二个参数表示对象的地址 </li>
<li>后面为输入参数留空 <code>using std::placeholders::_[i]</code></li>
</ul>
<p><code>std::make_shared&lt;MyNode&gt;()</code>创建节点指针</p>
<ul>
<li>&lt;&gt;内为节点类型</li>
<li>返回值为<code>std::shared_ptr</code>类型对象</li>
</ul>
<p><font color="Violetred">注意，创建函数的时候<code>SharedPtr</code> 已经代表指针，不要带&amp;</font></p>
<p><code>using namespace std::placeholders</code> 实现函数占位符</p>
<p><code>using namespace std::chrono_literals</code> 可以直接输入时间</p>
<p>C++ lambda函数：匿名函数</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[capture list] (parameter list) -&gt; <span class="keyword">return</span> type { function body }</span><br></pre></td></tr></tbody></table></figure>

<h2 id="ROS2概述与环境搭建"><a href="#ROS2概述与环境搭建" class="headerlink" title="ROS2概述与环境搭建"></a>ROS2概述与环境搭建</h2><h3 id="ROS2简介"><a href="#ROS2简介" class="headerlink" title="ROS2简介"></a>ROS2简介</h3><p>整个ROS生态由通信（Plumbing）、工具（Tools）、功能（Capabilities）与社区（Community）四大部分组成</p>
<p><img src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/YJS1/ROS%E7%BB%84%E6%88%90%E4%BD%93%E7%B3%BB.png" alt="ROS组成体系"></p>
<p>ROS2是全新一代机器人操作系统，不只是功能增强的ROS1</p>
<p>本文档采用的是ROS2的humble版本，运行在Linux（Ubuntu 22.04）操作系统上</p>
<h3 id="ROS2对比ROS"><a href="#ROS2对比ROS" class="headerlink" title="ROS2对比ROS"></a>ROS2对比ROS</h3><p>ROS 1：围绕一个集中式的 ROS Master 节点构建，它负责节点发现、注册、连接建立（主题、服务、动作服务器/客户端）和参数服务器。节点间通信主要使用 <strong>TCPROS/UDPROS</strong> 等自定义协议</p>
<p>ROS 2：采用完全去中心化的设计，它基于数据分发服务 (DDS) 标准作为其默认的中间件。DDS 本身就是一个成熟、标准化、去中心化的发布/订阅框架，内置了丰富的服务质量和发现机制</p>
<p>ROS2移除 Master 消除了单点故障，构建系统从Catkin→Ament / Colcon</p>
<h3 id="ROS2安装"><a href="#ROS2安装" class="headerlink" title="ROS2安装"></a>ROS2安装</h3><p>虚拟机部分转ROS文档</p>
<p>安装Ubuntu后需要把当前用户设为管理员，否则sudo会失败</p>
<p>大致步骤如下：</p>
<ol>
<li>准备1：设置语言环境；</li>
<li>准备2：启动Ubuntu universe存储库；</li>
<li>设置软件源；</li>
<li>安装ROS2；</li>
<li>配置环境。</li>
</ol>
<p><strong>准备1：设置语言环境</strong></p>
<p>请先检查本地语言环境是否支持UTF-8编码，可调用如下指令检查并设置UTF-8编码：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">locale  # 检查是否支持 UTF-8</span><br><span class="line">sudo apt update &amp;&amp; sudo apt install locales</span><br><span class="line">sudo locale-gen en_US en_US.UTF-8</span><br><span class="line">sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8</span><br><span class="line">export LANG=en_US.UTF-8</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>注意：语言环境可以不同，但必须支持UTF-8编码</p>
<p><strong>准备2：启动Ubuntu universe存储库</strong></p>
<p>打开软件与更新(Software &amp; Updates)窗口，确保启动了universe存储库，以保证可以下载”社区维护的免费和开源软件“</p>
<p>下载自可以改为清华源</p>
<p><strong>设置软件源</strong></p>
<p>先将ROS 2 apt存储库添加到系统，用apt授权的GPG密钥：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt install curl gnupg lsb-release</span><br><span class="line">sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg</span><br></pre></td></tr></tbody></table></figure>

<p>然后将存储库添加到源列表：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(source /etc/os-release &amp;&amp; echo $UBUNTU_CODENAME) main" | sudo tee /etc/apt/sources.list.d/ros2.list &gt; /dev/null</span><br></pre></td></tr></tbody></table></figure>

<p><strong>安装ROS2</strong></p>
<p>首先更新apt存储库缓存：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></tbody></table></figure>

<p>然后升级已安装的软件(ROS2软件包建立在经常更新的Ubuntu系统上，在安装新软件包之前请确保系统是最新的)：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt upgrade</span><br></pre></td></tr></tbody></table></figure>

<p>安装桌面版ROS2(建议)，包含ROS、RViz、示例与教程：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ros-humble-desktop</span><br></pre></td></tr></tbody></table></figure>

<p>过程中可能会报错，安装工具</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install aptitude </span><br><span class="line">sudo aptitude install xxx  # 根据方案来解决安装报错问题</span><br></pre></td></tr></tbody></table></figure>

<p><strong>配置环境</strong></p>
<p>终端下，执行ROS2程序时，需要调用如下命令配置环境：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /opt/ros/humble/setup.bash</span><br></pre></td></tr></tbody></table></figure>

<p>每次新开终端时，都得执行上述命令，或者将配置环境指令写入 ”~/.bashrc“ 文件，则以后新开终端不再需要手动配置环境：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "source /opt/ros/humble/setup.bash" &gt;&gt; ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>

<p>安装测试：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtlesim_node</span><br><span class="line">ros2 run turtlesim turtle_teleop_key</span><br></pre></td></tr></tbody></table></figure>

<p><strong>安装colcon构建工具</strong></p>
<p>colcon是一个命令行工具，用于改进编译，测试和使用多个软件包的工作流程</p>
<p>安装命令如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python3-colcon-common-extensions</span><br></pre></td></tr></tbody></table></figure>

<p>安装完colcon之后，就可以在ROS2中编写应用程序了</p>
<p><strong>运行优化</strong></p>
<p>每次终端中执行工作空间下的节点时，都需要调用<code>. install/setup.bash</code>指令，使用不便，可以将该指令的调用添加进<code>~/setup.bash</code>，操作格式如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "source /{工作空间路径}/install/setup.bash" &gt;&gt; ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>

<h3 id="ROS2集成开发环境"><a href="#ROS2集成开发环境" class="headerlink" title="ROS2集成开发环境"></a>ROS2集成开发环境</h3><p>在刚刚的过程会发现ubuntu频繁需要密码，打开terminal，输入seahorse</p>
<p>右键Login更改密码，将新密码设为空即可</p>
<h4 id="终端"><a href="#终端" class="headerlink" title="终端"></a>终端</h4><p>在 ROS 中，需要频繁的使用到终端，且可能需要同时开启多个窗口，推荐使用<strong>Terminator</strong></p>
<p>安装：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install terminator</span><br></pre></td></tr></tbody></table></figure>

<p>常用快捷键：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Alt+Up                          //移动到上面的终端</span><br><span class="line">Alt+Down                        //移动到下面的终端</span><br><span class="line">Alt+Left                        //移动到左边的终端</span><br><span class="line">Alt+Right                       //移动到右边的终端</span><br><span class="line">Ctrl+Shift+O                    //水平分割终端</span><br><span class="line">Ctrl+Shift+E                    //垂直分割终端</span><br></pre></td></tr></tbody></table></figure>

<h4 id="VScode"><a href="#VScode" class="headerlink" title="VScode"></a>VScode</h4><p>不要下Ubuntu software里的，可能无法输入中文</p>
<p>去官网下deb文件，下载后在终端中打开，输入命令安装</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i xxxx.deb</span><br></pre></td></tr></tbody></table></figure>

<p>vscode 下载插件：Chinese，C++，CMake，Cmake Tools，Python，Msg Language Support，URDF，vscode-pdf，YAML，XML</p>
<p>快捷键配置：向上向下复制行；向上向下移动</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38463737/article/details/125505154">VS Code设置打开新窗口不覆盖前窗口</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_70703397/article/details/129281455">VSCode设置自动保存</a></p>
<p>在VSCode中，cpp文件中的<code>#include "rclcpp/rclcpp.hpp"</code>包含语句会抛出异常，这是因为没有设置VSCode配置文件中 includepath属性，可以按照如下步骤解决此问题：</p>
<ol>
<li>将鼠标移到错误提示语句，此时会出现弹窗；</li>
<li>点击弹窗中的快速修复，会有新的弹窗，再点击<code>编辑"includePath"设置</code>；</li>
<li>在新页面中，包含路径属性对应的文本域中，换行输入被包含的路径<code>/opt/ros/humble/include/**</code></li>
</ol>
<h4 id="git"><a href="#git" class="headerlink" title="git"></a>git</h4><p>安装命令：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install git</span><br></pre></td></tr></tbody></table></figure>

<p>在本教程中会经常使用<code>git clone 仓库地址</code>的方式来将Git仓库拷贝到本地</p>
<h4 id="操作命令"><a href="#操作命令" class="headerlink" title="操作命令"></a>操作命令</h4><p>可以通过编译指令<code>colcon</code>和ROS2内置的工具指令<code>ros2</code>来实现功能包的创建、编译、查找与执行等相关操作</p>
<blockquote>
<p><code>colcon</code> 是官方推荐的构建工具，<code>CMake</code> 是底层的构建系统</p>
</blockquote>
<p><strong>创建</strong></p>
<p>新建功能包语法如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create [包名] --build-type [构建类型] --dependencies [依赖列表] --node-name [可执行程序名称]</span><br></pre></td></tr></tbody></table></figure>

<p>格式解释：</p>
<ul>
<li>–build-type：是指功能包的构建类型，有cmake、ament_cmake(c++)、ament_python(python)三种类型可选；</li>
<li>–dependencies：所依赖的功能包列表，空格分割多个功能包；</li>
<li>–node-name：可执行程序的名称，会自动生成对应的源文件并生成配置文件</li>
</ul>
<p><strong>编译</strong></p>
<p>编译功能包语法如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">colcon build</span><br><span class="line">colcon build --packages-select [功能包列表]</span><br></pre></td></tr></tbody></table></figure>

<p>前者会构建工作空间下的所有功能包，后者可以构建指定功能包</p>
<p>编译后刷新环境变量才可以执行（如果在.bashrc文件中已经添加则不需要）</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. install/setup.bash</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>从ROS1的<code>source ./devel/setup.bash</code> -&gt; . install/setup.bash</p>
</blockquote>
<p><strong>查找</strong></p>
<p>在<code>ros2 pkg</code>命令下包含了多个查询功能包相关信息的参数。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg executables ([包名]) # 输出所有功能包或指定功能包下的可执行程序。</span><br><span class="line">ros2 pkg list # 列出所有功能包</span><br><span class="line">ros2 pkg prefix [包名] # 列出功能包路径</span><br><span class="line">ros2 pkg xml # 输出功能包的package.xml内容</span><br></pre></td></tr></tbody></table></figure>

<p><strong>执行</strong></p>
<p>执行命令语法如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run [功能包] [可执行程序] [参数]</span><br></pre></td></tr></tbody></table></figure>

<h3 id="ROS2体系框架"><a href="#ROS2体系框架" class="headerlink" title="ROS2体系框架"></a>ROS2体系框架</h3><h4 id="ROS2文件系统"><a href="#ROS2文件系统" class="headerlink" title="ROS2文件系统"></a>ROS2文件系统</h4><p>立足系统架构，ROS2可以划分为三层</p>
<p><strong>操作系统层（OS Layer）</strong></p>
<p>ROS虽然称之为机器人操作系统，但实质只是构建机器人应用程序的软件开发工具包，ROS必须依赖于传统意义的操作系统</p>
<p><strong>中间层（Middleware Layer）</strong></p>
<p>主要由数据分发服务DDS与ROS2封装的关于机器人开发的中间件组成。DDS是一种去中心化的数据通讯方式，ROS2还引入了服务质量管理 （Quality of Service）机制，借助该机制可以保证在某些较差网络环境下也可以具备良好的通讯效果。ROS2中间件则主要由客户端库、DDS抽象层与进程内通讯API构成</p>
<p><strong>应用层（Application Layer）</strong></p>
<p>指开发者构建的应用程序，在应用程序中是以功能包为核心的，在功能包中可以包含源码、数据定义、接口等内容</p>
<p><img src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/YJS1/1.5.1%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.webp" alt="1.5.1文件系统"></p>
<p>对于一般开发者而言，工作内容主要集中在应用层，开发者一般通过实现具有某一特定功能的功能包来构建机器人应用程序</p>
<p>功能包是ROS2应用程序的核心，但是功能包不能直接构建，必须依赖于工作空间，一个ROS2工作空间的目录结构如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">WorkSpace --- 自定义的工作空间。</span><br><span class="line">    |--- build：存储中间文件的目录，该目录下会为每一个功能包创建一个单独子目录。</span><br><span class="line">    |--- install：安装目录，该目录下会为每一个功能包创建一个单独子目录。</span><br><span class="line">    |--- log：日志目录，用于存储日志文件。</span><br><span class="line">    |--- src：用于存储功能包源码的目录。</span><br><span class="line">        |-- C++功能包</span><br><span class="line">            |-- package.xml：包信息，比如:包名、版本、作者、依赖项。</span><br><span class="line">            |-- CMakeLists.txt：配置编译规则，比如源文件、依赖项、目标文件。</span><br><span class="line">            |-- src：C++源文件目录。</span><br><span class="line">            |-- include：头文件目录。</span><br><span class="line">            |-- msg：消息接口文件目录。</span><br><span class="line">            |-- srv：服务接口文件目录。</span><br><span class="line">            |-- action：动作接口文件目录。</span><br><span class="line">        |-- Python功能包</span><br><span class="line">            |-- package.xml：包信息，比如:包名、版本、作者、依赖项。</span><br><span class="line">            |-- setup.py：与C++功能包的CMakeLists.txt类似。</span><br><span class="line">            |-- setup.cfg：功能包基本配置文件。</span><br><span class="line">            |-- resource：资源目录。</span><br><span class="line">            |-- test：存储测试相关文件。</span><br><span class="line">            |-- 功能包同名目录：Python源文件目录。</span><br></pre></td></tr></tbody></table></figure>

<p>无论是Python功能包还是C++功能包，都可以自定义一些配置文件相关的目录</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|-- C++或Python功能包</span><br><span class="line">    |-- launch：存储launch文件。</span><br><span class="line">    |-- rviz：存储rviz2配置相关文件。</span><br><span class="line">    |-- urdf：存储机器人建模文件。</span><br><span class="line">    |-- params：存储参数文件。</span><br><span class="line">    |-- world：存储仿真环境相关文件。</span><br><span class="line">    |-- map：存储导航所需地图文件。</span><br><span class="line">    |-- ......</span><br></pre></td></tr></tbody></table></figure>

<h5 id="源文件说明"><a href="#源文件说明" class="headerlink" title="源文件说明"></a>源文件说明</h5><p>无论是C++实现还是Python实现，都是直接实例化的Node对象</p>
<p>更推荐以继承Node的方式来创建节点对象</p>
<p>C++继承Node实现示例如下：</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">newNode</span>: <span class="keyword">public</span> rclcpp::Node{ <span class="comment">// newNode继承ROS2节点基类</span></span><br><span class="line"><span class="keyword">public</span>: <span class="comment">// 公共访问区域</span></span><br><span class="line">    <span class="built_in">newNode</span>():<span class="built_in">Node</span>(<span class="string">"node_name"</span>){ <span class="comment">// 调用父类Node构造函数newNode()</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"hello world!"</span>); <span class="comment">// this 是指向当前对象实例的指针</span></span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    rclcpp::<span class="built_in">init</span>(argc,argv); <span class="comment">// ROS2初始化</span></span><br><span class="line">    <span class="keyword">auto</span> node = std::<span class="built_in">make_shared</span>&lt;newNode&gt;(); <span class="comment">// 创建类实例,()内传参</span></span><br><span class="line">    rclcpp::<span class="built_in">shutdown</span>(); <span class="comment">// 资源清理</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>Python继承Node实现示例如下：</p>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> rclpy</span><br><span class="line"><span class="keyword">from</span> rclpy.node <span class="keyword">import</span> Node</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">newNode</span>(<span class="title class_ inherited__">Node</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(<span class="string">"node_name_py"</span>)</span><br><span class="line">        <span class="variable language_">self</span>.get_logger().info(<span class="string">"hello world!"</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    rclpy.init()</span><br><span class="line">    node = newNode() </span><br><span class="line">    rclpy.shutdown()</span><br></pre></td></tr></tbody></table></figure>

<p>之所以继承比直接实例化Node更被推荐，是因为继承方式可以在一个进程内组织多个节点，这对于提高节点间的通信效率是很有帮助的，但是直接实例化则与该功能不兼容</p>
<p><strong>初始化与资源释放在程序中起什么作用？</strong></p>
<ol>
<li><p>前提：构建的程序可能由若干步骤或阶段组成</p>
<p>初始化–&gt;节点对象–日志输出–&gt;数据的发布—&gt;数据订阅–&gt;…–&gt;资源释放</p>
</li>
<li><p>不同步骤或阶段之间涉及到数据的传递</p>
</li>
<li><p>使用context(上下文)对象进行数据传递，这是一个容器，可以存储数据，也可以从中读取数据</p>
</li>
<li><p>初始化其实就是要创建context对象，资源释放就是要销毁context对象</p>
</li>
</ol>
<h5 id="配置文件说明"><a href="#配置文件说明" class="headerlink" title="配置文件说明"></a>配置文件说明</h5><p>C++功能包的构建信息主要包含在package.xml与CMakeLists.txt中</p>
<p>Python功能包的构建信息则主要包含在package.xml和setup.py中</p>
<p><strong>package.xml</strong></p>
<p>不管是何种类型的功能包，package.xml的格式都是类似的，在该文件中包含了包名、版本、作者、依赖项的信息，可以为colcon构建工具确定功能包的编译顺序</p>
<p>一个简单的package.xml示例如下：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-model href=<span class="string">"http://download.ros.org/schema/package_format3.xsd"</span> schematypens=<span class="string">"http://www.w3.org/2001/XMLSchema"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">format</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>pkg01_helloworld_cpp<span class="tag">&lt;/<span class="name">name</span>&gt;</span> 包名</span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span> 包的版本号</span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>TODO: Package description<span class="tag">&lt;/<span class="name">description</span>&gt;</span> 包的描述信息</span><br><span class="line">  <span class="tag">&lt;<span class="name">maintainer</span> <span class="attr">email</span>=<span class="string">"[联系者邮箱]"</span>&gt;</span>ros2<span class="tag">&lt;/<span class="name">maintainer</span>&gt;</span> 维护者信息</span><br><span class="line">  <span class="tag">&lt;<span class="name">license</span>&gt;</span>TODO: License declaration<span class="tag">&lt;/<span class="name">license</span>&gt;</span> 软件协议</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">buildtool_depend</span>&gt;</span>ament_cmake<span class="tag">&lt;/<span class="name">buildtool_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">depend</span>&gt;</span>rclcpp<span class="tag">&lt;/<span class="name">depend</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">test_depend</span>&gt;</span>ament_lint_auto<span class="tag">&lt;/<span class="name">test_depend</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">test_depend</span>&gt;</span>ament_lint_common<span class="tag">&lt;/<span class="name">test_depend</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">export</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build_type</span>&gt;</span>ament_cmake<span class="tag">&lt;/<span class="name">build_type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">export</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>package：根标签，format属性用来声明文件的格式版本</p>
<p>依赖项：</p>
<ul>
<li><p>buildtool_depend：声明编译工具依赖；</p>
</li>
<li><p>build_depend：声明编译依赖；</p>
</li>
<li><p>build_export_depend：声明根据此包构建库所需依赖；</p>
</li>
<li><p>exec_depend：声明执行时依赖；</p>
<blockquote>
<p>build_depend，build_export_depend，exec_depend很多时候是一样的</p>
</blockquote>
</li>
<li><p>depend：相当于<build_depend>、<build_export_depend>、<exec_depend>三者的集成；</exec_depend></build_export_depend></build_depend></p>
</li>
<li><p>test_depend：声明测试依赖；</p>
</li>
<li><p>doc_depend：声明构建文档依赖</p>
</li>
</ul>
<p><strong>CMakeLists.txt</strong></p>
<p>C++功能包中需要配置CMakeLists.txt文件，该文件描述了如何构建C++功能包</p>
<p>一个简单的CMakeLists.txt示例如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># 声明cmake的最低版本</span><br><span class="line">cmake_minimum_required(VERSION 3.8)</span><br><span class="line"># 包名，需要与package.xml中的包名一致</span><br><span class="line">project(pkg01_helloworld_cpp)</span><br><span class="line"></span><br><span class="line">if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")</span><br><span class="line">  add_compile_options(-Wall -Wextra -Wpedantic)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"># find dependencies</span><br><span class="line">find_package(ament_cmake REQUIRED)</span><br><span class="line"># 引入外部依赖包</span><br><span class="line">find_package(rclcpp REQUIRED)</span><br><span class="line"></span><br><span class="line"># 映射源文件与可执行文件</span><br><span class="line">add_executable(helloworld src/helloworld.cpp)</span><br><span class="line"># 设置目标依赖库</span><br><span class="line">ament_target_dependencies(</span><br><span class="line">  helloworld</span><br><span class="line">  "rclcpp"</span><br><span class="line">)</span><br><span class="line"># 定义安装规则</span><br><span class="line">install(TARGETS helloworld</span><br><span class="line">  DESTINATION lib/${PROJECT_NAME})</span><br><span class="line"></span><br><span class="line">if(BUILD_TESTING)</span><br><span class="line">  find_package(ament_lint_auto REQUIRED)</span><br><span class="line">  # the following line skips the linter which checks for copyrights</span><br><span class="line">  # comment the line when a copyright and license is added to all source files</span><br><span class="line">  set(ament_cmake_copyright_FOUND TRUE)</span><br><span class="line">  # the following line skips cpplint (only works in a git repo)</span><br><span class="line">  # comment the line when this package is in a git repo and when</span><br><span class="line">  # a copyright and license is added to all source files</span><br><span class="line">  set(ament_cmake_cpplint_FOUND TRUE)</span><br><span class="line">  ament_lint_auto_find_test_dependencies()</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line">ament_package()</span><br></pre></td></tr></tbody></table></figure>

<p><strong>setup.py</strong></p>
<p>Python功能包中需要配置setup.py文件，该文件描述了如何构建Python功能包</p>
<p>一个简单的setup.py示例如下：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup</span><br><span class="line"></span><br><span class="line">package_name = <span class="string">'pkg02_helloworld_py'</span></span><br><span class="line"></span><br><span class="line">setup(</span><br><span class="line">    name=package_name, <span class="comment"># 包名</span></span><br><span class="line">    version=<span class="string">'0.0.0'</span>,   <span class="comment"># 版本</span></span><br><span class="line">    packages=[package_name], <span class="comment"># 功能包列表</span></span><br><span class="line">    data_files=[ <span class="comment">#需要被安装的文件以及安装路径</span></span><br><span class="line">        (<span class="string">'share/ament_index/resource_index/packages'</span>,</span><br><span class="line">            [<span class="string">'resource/'</span> + package_name]),</span><br><span class="line">        (<span class="string">'share/'</span> + package_name, [<span class="string">'package.xml'</span>]),</span><br><span class="line">    ],</span><br><span class="line">    install_requires=[<span class="string">'setuptools'</span>], <span class="comment"># 安装依赖</span></span><br><span class="line">    zip_safe=<span class="literal">True</span>,</span><br><span class="line">    maintainer=<span class="string">'ros2'</span>, <span class="comment"># 维护者</span></span><br><span class="line">    maintainer_email=<span class="string">'ros2@todo.todo'</span>, <span class="comment"># 维护者 email</span></span><br><span class="line">    description=<span class="string">'TODO: Package description'</span>, <span class="comment"># 包描述</span></span><br><span class="line">    license=<span class="string">'TODO: License declaration'</span>, <span class="comment"># 软件协议</span></span><br><span class="line">    tests_require=[<span class="string">'pytest'</span>], <span class="comment"># 测试依赖</span></span><br><span class="line">    entry_points={</span><br><span class="line">        <span class="string">'console_scripts'</span>: [</span><br><span class="line">            <span class="comment"># 映射源文件与可执行文件</span></span><br><span class="line">            <span class="string">'helloworld = pkg02_helloworld_py.helloworld:main'</span></span><br><span class="line">        ],</span><br><span class="line">    },</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>所以不建议修改包名</p>
<h4 id="ROS2核心模块"><a href="#ROS2核心模块" class="headerlink" title="ROS2核心模块"></a>ROS2核心模块</h4><p><strong>通信模块</strong></p>
<p><strong>功能包</strong></p>
<p>安装方式：</p>
<ul>
<li><p>二进制安装</p>
<p>ROS官方或社区提供的功能包可以很方便的通过二进制方式安装</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ros-[ROS2版本代号]-[功能包名称]</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>可以调用<code>apt search ros-ROS2版本代号-* | grep -i [关键字]</code>格式的命令，根据关键字查找所需的功能包</p>
</blockquote>
</li>
<li><p>源码安装</p>
<p>一般从github获取源码，下载命令如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone [仓库地址]</span><br></pre></td></tr></tbody></table></figure>

<p>源码下载后，需要自行编译</p>
</li>
</ul>
<p><strong>分布式</strong></p>
<p>ROS2是一个分布式架构，不同的ROS2设备之间可以方便的实现通信，这在多机器人设备协同中是极其重要的</p>
<p><strong>终端命令与rqt</strong></p>
<p>rqt是一个图形化工具，它的功能与命令行工具类似，但是图形化的交互方式更为友好</p>
<p><strong>launch文件</strong></p>
<p>通过launch文件，可以批量的启动ROS2节点，这是在构建大型项目时启动多节点的常用方式</p>
<p><strong>TF坐标变换</strong></p>
<p>TF坐标变换可以实现机器人不同部件或不同机器人之间的相对位置关系的转换</p>
<p><strong>可视化</strong></p>
<p>ROS2内置了三维可视化工具rviz2，它可以图形化的方式显示机器人模型或显示机器人系统中的一些抽象数据</p>
<h4 id="ROS2技术支持"><a href="#ROS2技术支持" class="headerlink" title="ROS2技术支持"></a>ROS2技术支持</h4><p><a target="_blank" rel="noopener" href="https://docs.ros.org/en/humble/">ROS 2 文档 — ROS 2 文档：Humble 文档</a></p>
<h4 id="ROS2应用方向"><a href="#ROS2应用方向" class="headerlink" title="ROS2应用方向"></a>ROS2应用方向</h4><p><strong>NAV2</strong></p>
<p>Nav2项目继承自ROS Navigation Stack。该项目旨在可以让移动机器人从A点安全的移动到B点。它也可以应用于涉及机器人导航的其他应用，例如跟随动态点。Nav2将用于实现路径规划、运动控制、动态避障和恢复行为等一系列功能</p>
<p><strong>OpenCV</strong></p>
<p><a target="_blank" rel="noopener" href="https://opencv.org/">OpenCV</a>（Open Source Computer Vision Library）是一个开源的计算机视觉和机器学习软件库。OpenCV旨在为计算机视觉应用程序提供通用基础架构，并加速机器感知在商业产品中的使用。OpenCV允许企业轻松地使用和修改代码</p>
<p><strong>MoveIt</strong></p>
<p><a target="_blank" rel="noopener" href="https://moveit.ros.org/">MoveIt</a>是一组ROS软件包， 主要包含运动规划、碰撞检测、运动学、3D感知、操作控制等功能。它可以用于构建机械臂的高级行为。MoveIt现在可以用于市面上的大多数机械臂，并被许多大公司使用</p>
<p><strong>The Autoware Foundation</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.autoware.org/">Autoware Foundation</a>是ROS下属的非营利组织，支持实现自动驾驶的开源项目。Autoware基金会在企业发展和学术研究之间创造协同效应，为每个人提供自动驾驶技术</p>
<p><strong>F1 Tenth</strong></p>
<p><a target="_blank" rel="noopener" href="https://f1tenth.org/">F1 Tenth</a>是将模型车改为无人车的竞速赛事，是一个由研究人员、工程师和自主系统爱好者组成的国际社区。它最初于 2016 年在宾夕法尼亚大学成立，但后来扩展到全球许多其他机构</p>
<p><strong>microROS</strong></p>
<p>在基于ROS的机器人应用中，<a target="_blank" rel="noopener" href="https://micro.ros.org/">micro-ROS</a>正在弥合性能有限的微控制器和一般处理器之间的差距。micro-ROS在各种嵌入式硬件上运行，使ROS能直接应用于机器人硬件</p>
<p><strong>Open Robotics</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.openrobotics.org/">Open Robotics</a>与全球ROS社区合作，为机器人创建开放的软件和硬件平台，包括 ROS1、ROS2、Gazebo模拟器和Ignition模拟器。Open Robotics使用这些平台解决一些重要问题，并通过为各种客户组织提供软件和硬件开发服务来帮助其他人做同样的事情。</p>
<p><strong>PX4</strong></p>
<p><a target="_blank" rel="noopener" href="https://px4.io/">PX4</a>是一款用于无人机和其他无人驾驶车辆的开源飞行控制软件。该项目为无人机开发人员提供了一套灵活的工具，用于共享技术并为无人机应用程序创建量身定制解决方案</p>
<h2 id="ROS2通信机制核心"><a href="#ROS2通信机制核心" class="headerlink" title="ROS2通信机制核心"></a>ROS2通信机制核心</h2><h3 id="通信机制简介"><a href="#通信机制简介" class="headerlink" title="通信机制简介"></a>通信机制简介</h3><p><strong>节点</strong></p>
<p>在通信时，不论采用何种方式，通信对象的构建都依赖于节点(Node)，在ROS2中，一般情况下每个节点都对应某一单一的功能模块</p>
<p>一个完整的机器人系统可能由许多协同工作的节点组成，ROS2中的单个可执行文件(C++程序或Python程序)可以包含一个或多个节点</p>
<p><strong>话题</strong></p>
<p>话题(Topic)是一个纽带，具有相同话题的节点可以关联在一起，这正是通信的前提。ROS2是跨语言的，只要二者使用了相同的话题，就可以实现数据的交互。</p>
<p><strong>通信模型</strong></p>
<p>在ROS2中，常用的通信模型有四种：</p>
<ol>
<li>话题通信：是一种单向通信模型，在通信双方中，发布方发布数据，订阅方订阅数据，数据流单向的由发布方传输到订阅方</li>
<li>服务通信：是一种基于请求响应的通信模型，在通信双方中，客户端发送请求数据到服务端，服务端响应结果给客户端</li>
<li>动作通信：是一种带有连续反馈的通信模型，在通信双方中，客户端发送请求数据到服务端，服务端响应结果给客户端，但是在服务端接收到请求到产生最终响应的过程中，会发送连续的反馈信息到客户端</li>
<li>参数服务：是一种基于共享的通信模型，在通信双方中，服务端可以设置数据，而客户端可以连接服务端并操作服务端数据</li>
</ol>
<p><img src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/YJS1/Snipaste_2025-06-30_22-06-00.webp" alt="Snipaste_2025-06-30_22-06-00"></p>
<p><strong>接口</strong></p>
<p>在通信过程中，需要传输数据，就必然涉及到数据载体，即要以特定格式传输数据</p>
<p>在ROS2中，数据载体称之为接口(interfaces)，通信时使用的数据载体一般需要使用接口文件定义</p>
<p>常用的接口文件有三种：msg文件、srv文件与action文件，每种文件都可以按照一定格式定义特定数据类型的“变量”</p>
<ul>
<li><p>msg文件</p>
<p>用于定义话题通信中数据载体的接口文件，示例如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int64 num1</span><br><span class="line">int64 num2</span><br></pre></td></tr></tbody></table></figure>

<p>在文件中声明了一些被传输的变量数据</p>
</li>
<li><p>srv文件</p>
<p>用于定义服务通信中数据载体的接口文件，示例如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int64 num1</span><br><span class="line">int64 num2</span><br><span class="line">---</span><br><span class="line">int64 sum</span><br></pre></td></tr></tbody></table></figure>

<p>文件中声明的数据被<code>---</code>分割为两部分，上半部分用于声明请求数据，下半部分用于声明响应数据</p>
</li>
<li><p>action文件</p>
<p>用于定义动作通信中数据载体的接口文件，示例如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int64 num</span><br><span class="line">---</span><br><span class="line">int64 sum</span><br><span class="line">---</span><br><span class="line">float64 progress</span><br></pre></td></tr></tbody></table></figure>

<p>文件中声明的数据被<code>---</code>分割为三部分，上半部分用于声明请求数据，中间部分用于声明响应数据，下半部分用于声明连续反馈数据</p>
</li>
</ul>
<p>可以使用的字段类型有：</p>
<ul>
<li>int8, int16, int32, int64 (或者无符号类型: uint*)</li>
<li>float32, float64</li>
<li>string</li>
<li>time, duration</li>
<li>其他msg文件</li>
<li>变长数组和定长数组</li>
</ul>
<p>ROS中还有一种特殊类型：<code>Header</code>，标头包含时间戳和ROS2中常用的坐标帧信息，许多接口文件的第一行包含<code>Header</code>标头</p>
<p><font color="Violetred">参数通信的数据无需定义接口文件</font>，参数通信时数据会被封装为参数对象，参数客户端和服务端操作的都是参数对象</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ol>
<li><p>请先创建工作空间<code>ws01_plumbing</code>，本章以及第3章代码部分内容存储在该工作空间下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ws01_plumbing/src</span><br><span class="line">cd ws01_plumbing/src</span><br><span class="line">colcon build</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>实际应用中一般建议创建专门的接口功能包定义接口文件，当前教程也遵循这一建议，预先创建教程所需使用的接口功能包</p>
<blockquote>
<p>需要注意的是，目前为止无法在Python功能包中定义接口文件</p>
</blockquote>
<p>终端下进入工作空间的<code>src</code>目录，执行如下命令：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create --build-type ament_cmake [base_interfaces]</span><br></pre></td></tr></tbody></table></figure>

<p>该功能包将用于保存本章教程中自定义的接口文件</p>
</li>
</ol>
<p><font color="Violetred">注意</font>：功能包可以在vscode里创建，但是工作空间建议在终端先创建好，再用vscode打开</p>
<h3 id="话题通信"><a href="#话题通信" class="headerlink" title="话题通信"></a>话题通信</h3><p>话题通信是ROS中使用频率最高的一种通信模式，话题通信是基于<strong>发布订阅</strong>模式</p>
<blockquote>
<p>一个节点发布消息，另一个节点订阅该消息</p>
</blockquote>
<p>像雷达、摄像头、GPS…. 等等传感器数据的采集都是使用话题通信</p>
<p>数据发布对象称为发布方，数据订阅对象称之为订阅方，发布方和订阅方通过话题相关联，消息的流向是单向的</p>
<p>话题通信的发布方与订阅方是一种多对多的关系，这意味着数据会出现交叉传输的情况</p>
<p><font color="Violetred">可以通过<code>rqt</code>命令查看话题之间的关系</font></p>
<img src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/YJS1/2.2话题通信模型2 (1).gif" alt="2.2话题通信模型2 (1)" style="zoom: 80%;">

<blockquote>
<p>与ROS1不同的是，现在不需要master了，不存在master挂了整个系统崩溃的情况</p>
</blockquote>
<p><font color="Violetred">话题通信一般应用于不断更新的、少逻辑处理的数据传输场景</font></p>
<p>关于消息接口的使用有多种方式：</p>
<ol>
<li>在ROS2中通过std_msgs包封装了一些原生的数据类型，这些原生数据类型也可以作为话题通信的载体，不过这些数据一般只包含一个 data 字段，而std_msgs包中其他的接口文件也比较简单，结构的单一意味着功能上的局限性，当传输一些结构复杂的数据时，就显得力不从心了；</li>
<li>在ROS2中还预定义了许多标准话题消息接口，这在实际工作中有着广泛的应用，比如：sensor_msgs包中定义了许多关于传感器消息的接口（雷达、摄像头、点云……），geometry_msgs包中则定义了许多几何消息相关的接口（坐标点、坐标系、速度指令……）；</li>
<li>如果上述接口文件都不能满足需求，那么就可以自定义接口消息；</li>
</ol>
<h4 id="案例需求"><a href="#案例需求" class="headerlink" title="案例需求"></a>案例需求</h4><p>需求1：编写话题通信实现，发布方以某个频率发布一段文本，订阅方订阅消息，并输出在终端</p>
<p>需求2：编写话题通信实现，发布方以某个频率发布自定义接口消息，订阅方订阅消息，并输出在终端</p>
<p>需求1和需求2的主要区别在于消息载体，前者可以使用原生的数据类型，后者需要自定义接口消息</p>
<p>终端下进入工作空间的src目录，调用命令分别创建C++功能包和Python功能包</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create cpp01_topic --build-type ament_cmake --dependencies rclcpp std_msgs base_interfaces [--node-name demo01_talker]</span><br><span class="line">ros2 pkg create py01_topic --build-type ament_python --dependencies rclpy std_msgs base_interfaces [--node-name demo01_talker_str_py]</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>对比ros1好处：CMakeList里自动配置，python现在依赖的setup.py也会自动配置</p>
<p>本笔记不记录python，只针对C++进行学习</p>
</blockquote>
<h4 id="原生消息"><a href="#原生消息" class="headerlink" title="原生消息"></a>原生消息</h4><p><strong>发布方实现</strong></p>
<p>功能包cpp01_topic的src目录下</p>
<p>demo01_talker_str.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">  需求：以某个固定频率发送文本“hello world!”，文本后缀编号，每发送一条消息，编号递增1。</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建发布方；</span></span><br><span class="line"><span class="comment">      3-2.创建定时器；</span></span><br><span class="line"><span class="comment">      3-3.组织消息并发布。</span></span><br><span class="line"><span class="comment">    4.调用spin函数，并传入节点对象指针；</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"std_msgs/msg/string.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals; <span class="comment">// 可以直接输入时间单位</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Talker</span>: <span class="keyword">public</span> rclcpp::Node{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">Talker</span>():<span class="built_in">Node</span>(<span class="string">"talker_node_cpp"</span>),<span class="built_in">count</span>(<span class="number">0</span>){ <span class="comment">// 调用基类构造函数设置节点名</span></span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"发布节点创建！"</span>);</span><br><span class="line">    <span class="comment">// 3-1.创建发布方；</span></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">      模板：被发布的消息类型；</span></span><br><span class="line"><span class="comment">      &lt;&gt;内为消息类型</span></span><br><span class="line"><span class="comment">      参数:</span></span><br><span class="line"><span class="comment">        1.话题名称;</span></span><br><span class="line"><span class="comment">        2.QOS(消息队列长度）</span></span><br><span class="line"><span class="comment">      返回值：发布对象指针</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    publisher_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_publisher</span>&lt;std_msgs::msg::String&gt;(<span class="string">"chatter"</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// 3-2.创建定时器；</span></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    参数:</span></span><br><span class="line"><span class="comment">      1.时问间隔;-&gt; 引入 using namespace std::chrono_literals</span></span><br><span class="line"><span class="comment">      2.回调函数;</span></span><br><span class="line"><span class="comment">    返回值：定时器对象指针</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    timer_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_wall_timer</span>(<span class="number">1</span>s,std::<span class="built_in">bind</span>(&amp;Talker::on_timer,<span class="keyword">this</span>));</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    std::bind()</span></span><br><span class="line"><span class="comment">    参数：</span></span><br><span class="line"><span class="comment">      1.要绑定的函数指针（&amp;Talker::on_timer）</span></span><br><span class="line"><span class="comment">      2.调用该函数的对象（this当前节点）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">on_timer</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="comment">// 3-3.组织消息并发布</span></span><br><span class="line">    <span class="keyword">auto</span> message =std_msgs::msg::<span class="built_in">String</span>();</span><br><span class="line">    message.data = <span class="string">"hello world!"</span>+std::<span class="built_in">to_string</span>(count++);</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"发布方数据:%s"</span>,message.data.<span class="built_in">c_str</span>());</span><br><span class="line">    publisher_-&gt;<span class="built_in">publish</span>(message);</span><br><span class="line">  }</span><br><span class="line">  rclcpp::Publisher&lt;std_msgs::msg::String&gt;::SharedPtr publisher_;</span><br><span class="line">  rclcpp::TimerBase::SharedPtr timer_;</span><br><span class="line">  <span class="type">size_t</span> count;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数，并传入节点类对象；</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;Talker&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>订阅方实现</strong></p>
<p>功能包cpp01_topic的src目录下</p>
<p>demo02_listener_str.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">    需求：订阅发布方发布的消息，并输出到终端。</span></span><br><span class="line"><span class="comment">    步骤：</span></span><br><span class="line"><span class="comment">        1.包含头文件；</span></span><br><span class="line"><span class="comment">        2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">        3.定义节点类；</span></span><br><span class="line"><span class="comment">            3-1.创建订阅方；</span></span><br><span class="line"><span class="comment">            3-2.处理订阅到的消息。</span></span><br><span class="line"><span class="comment">        4.调用spin函数，并传入节点对象指针；</span></span><br><span class="line"><span class="comment">        5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"std_msgs/msg/string.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::placeholders::_1; <span class="comment">// 引入函数参数占位符</span></span><br><span class="line"><span class="comment">// 可以直接使用 _1 和 _2 代替冗长的 std::placeholders::_1</span></span><br><span class="line"><span class="comment">// _1 表示新函数对象的第一个参数 _2 表示新函数对象的 第二个参数 以此类推</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.定义节点类；</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Listener</span>: <span class="keyword">public</span> rclcpp::Node{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Listener</span>(): <span class="built_in">Node</span>(<span class="string">"listener_node_cpp"</span>){</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"订阅方创建！"</span>);</span><br><span class="line">        <span class="comment">// 3-1.创建订阅方；</span></span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">            模板：消息类型;</span></span><br><span class="line"><span class="comment">            参数:</span></span><br><span class="line"><span class="comment">                1.话题名称;</span></span><br><span class="line"><span class="comment">                2.QOS，队列长度；</span></span><br><span class="line"><span class="comment">            返回值：订阅对象指针</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        subcription_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_subscription</span>&lt;std_msgs::msg::String&gt;(<span class="string">"chatter"</span>,<span class="number">10</span>,</span><br><span class="line">            std::<span class="built_in">bind</span>(&amp;Listener::do_cb,<span class="keyword">this</span>,_1));</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">do_cb</span><span class="params">(<span class="type">const</span> std_msgs::msg::String &amp;msg)</span></span>{</span><br><span class="line">        <span class="comment">// 3-2.解析并输出数据</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"订阅的消息：'%s'"</span>,msg.data.<span class="built_in">c_str</span>());</span><br><span class="line">    }</span><br><span class="line">    rclcpp::Subscription&lt;std_msgs::msg::String&gt;::SharedPtr subcription_;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">    rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">    <span class="comment">// 4.调用spin函数，并传入节点对象指针</span></span><br><span class="line">    rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;Listener&gt;());</span><br><span class="line">    <span class="comment">// 5.释放资源；</span></span><br><span class="line">    rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>CMakeLists.txt中发布和订阅程序核心配置如下，注意增加listener部分</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">add_executable(demo01_talker_str src/demo01_talker_str.cpp)</span><br><span class="line">add_executable(demo02_listener_str src/demo02_listener_str.cpp)</span><br><span class="line"></span><br><span class="line">ament_target_dependencies(</span><br><span class="line">  demo01_talker_str</span><br><span class="line">  "rclcpp"</span><br><span class="line">  "std_msgs"</span><br><span class="line">)</span><br><span class="line">ament_target_dependencies(</span><br><span class="line">  demo02_listener_str</span><br><span class="line">  "rclcpp"</span><br><span class="line">  "std_msgs"</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install(TARGETS </span><br><span class="line">  demo01_talker_str</span><br><span class="line">  demo02_listener_str</span><br><span class="line">  DESTINATION lib/${PROJECT_NAME})</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>CMakeLists配置包括<code>add_executable</code>、<code>ament_target_dependencies</code>、<code>install</code>三部分</p>
</blockquote>
<p><strong>编译</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">colcon build --packages-select cpp01_topic</span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置接口消息"><a href="#配置接口消息" class="headerlink" title="配置接口消息"></a>配置接口消息</h4><p><strong>创建并编辑 .msg 文件</strong></p>
<p>功能包base_interfaces下新建 msg 文件夹，msg文件夹下新建Student.msg文件，文件中输入如下内容：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">string   name</span><br><span class="line">int32    age</span><br><span class="line">float64  height</span><br></pre></td></tr></tbody></table></figure>

<p><strong>编辑配置文件</strong></p>
<p>在package.xml中需要添加一些依赖包</p>
<blockquote>
<p>不用特别记忆，调用<code>ros2 pkg list | grep -i rosidl</code></p>
<p><code>rosidl</code> 是 ROS 2 的核心组件，代表了ROS 接口定义语言</p>
</blockquote>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 编译依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>rosidl_default_generators<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 执行依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>rosidl_default_runtime<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 声明当前包所属的功能包组 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">member_of_group</span>&gt;</span>rosidl_interface_packages<span class="tag">&lt;/<span class="name">member_of_group</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 删除部分</span></span><br><span class="line"><span class="comment">&lt;test_depend&gt;ament_lint_auto&lt;/test_depend&gt;</span></span><br><span class="line"><span class="comment">&lt;test_depend&gt;ament_lint_common&lt;/test_depend&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>为了将<code>.msg</code>文件转换成对应的C++和Python代码，还需要在CMakeLists.txt中添加如下配置</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 添加依赖</span><br><span class="line">find_package(rosidl_default_generators REQUIRED)</span><br><span class="line"></span><br><span class="line"># 为接口文件生成源码</span><br><span class="line">rosidl_generate_interfaces(${PROJECT_NAME}</span><br><span class="line">  "msg/Student.msg"</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p><strong>编译功能包</strong></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">colcon build --packages-select base_interfaces</span><br></pre></td></tr></tbody></table></figure>

<p>编译完成之后，在工作空间下的nstall目录下将生成<code>Student.msg</code>文件对应的C++和Python文件</p>
<p><strong>测试</strong></p>
<p>通过如下命令查看文件定义以及编译是否正常</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">. install/setup.bash</span><br><span class="line">ros2 interface show base_interfaces/msg/Student</span><br></pre></td></tr></tbody></table></figure>

<p>正常情况下，终端将会输出与<code>Student.msg</code>文件一致的内容</p>
<h4 id="自定义消息"><a href="#自定义消息" class="headerlink" title="自定义消息"></a>自定义消息</h4><p><strong>准备</strong></p>
<p>C++文件中包含自定义消息相关头文件时，可能会抛出异常，可以配置VSCode中c_cpp_properties.json文件，在文件中的 includePath属性下添加</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">${workspaceFolder}/install/base_interfaces/include/**</span><br></pre></td></tr></tbody></table></figure>

<p>其他接口文件或接口包的使用也与此同理</p>
<p><strong>修改配置文件</strong></p>
<p>package.xml无需修改，CMakeLists.txt文件需要修改：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">add_executable(demo03_talker_stu src/demo03_talker_stu.cpp)</span><br><span class="line">ament_target_dependencies(</span><br><span class="line">  demo03_talker_stu</span><br><span class="line">  "rclcpp"</span><br><span class="line">  "std_msgs"</span><br><span class="line">  "base_interfaces"</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add_executable(demo04_listener_stu src/demo04_listener_stu.cpp)</span><br><span class="line">ament_target_dependencies(</span><br><span class="line">  demo04_listener_stu</span><br><span class="line">  "rclcpp"</span><br><span class="line">  "std_msgs"</span><br><span class="line">  "base_interfaces"</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">install(TARGETS </span><br><span class="line">  demo01_talker_str</span><br><span class="line">  demo02_listener_str</span><br><span class="line">  demo03_talker_stu</span><br><span class="line">  demo04_listener_stu</span><br><span class="line">  DESTINATION lib/${PROJECT_NAME})</span><br></pre></td></tr></tbody></table></figure>

<p><strong>发布方实现</strong></p>
<p>功能包cpp01_topic的src目录下</p>
<p>demo03_talker_stu.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">  需求：以某个固定频率发送文本学生信息，包含学生的姓名、年龄、身高等数据。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/msg/student.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals; <span class="comment">// 可以直接输入时间单位</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TalkerStu</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">TalkerStu</span>():<span class="built_in">Node</span>(<span class="string">"talkerstu_node_cpp"</span>),<span class="built_in">count</span>(<span class="number">0</span>){ <span class="comment">// 调用基类构造函数设置节点</span></span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"发布节点创建！"</span>);</span><br><span class="line">    <span class="comment">// 3-1.创建发布方；</span></span><br><span class="line">    publisher_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_publisher</span>&lt;base_interfaces::msg::Student&gt;(<span class="string">"chatter_stu"</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="comment">// 3-2.创建定时器；</span></span><br><span class="line">    timer_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_wall_timer</span>(<span class="number">1</span>s,std::<span class="built_in">bind</span>(&amp;TalkerStu::on_timer,<span class="keyword">this</span>));</span><br><span class="line">  }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">on_timer</span><span class="params">()</span></span>{</span><br><span class="line">    <span class="comment">// 3-3.组织消息并发布</span></span><br><span class="line">    <span class="keyword">auto</span> stu = base_interfaces::msg::<span class="built_in">Student</span>();</span><br><span class="line">    stu.name = <span class="string">"张三"</span>;</span><br><span class="line">    stu.age = count++;</span><br><span class="line">    stu.height = <span class="number">1.65</span>;</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"学生信息:name=%s,age=%d,height=%.2f"</span>,</span><br><span class="line">    stu.name.<span class="built_in">c_str</span>(),stu.age,stu.height);</span><br><span class="line">    publisher_-&gt;<span class="built_in">publish</span>(stu);</span><br><span class="line">  }</span><br><span class="line">  rclcpp::Publisher&lt;base_interfaces::msg::Student&gt;::SharedPtr publisher_;</span><br><span class="line">  rclcpp::TimerBase::SharedPtr timer_;</span><br><span class="line">  <span class="type">size_t</span> count;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数，并传入节点类对象；</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;TalkerStu&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>订阅方实现</strong></p>
<p>功能包cpp01_topic的src目录下</p>
<p>demo04_listener_stu.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">    需求：订阅发布方发布的学生消息，并输出到终端。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/msg/student.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::placeholders::_1; <span class="comment">// 表示"这里保留一个位置，实际参数将在调用时传入"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.定义节点类；</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ListenerStu</span>: <span class="keyword">public</span> rclcpp::Node{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ListenerStu</span>(): <span class="built_in">Node</span>(<span class="string">"listenerstu_node_cpp"</span>){</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"订阅方创建！"</span>);</span><br><span class="line">        <span class="comment">// 3-1.创建订阅方；</span></span><br><span class="line">        subcription_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_subscription</span>&lt;base_interfaces::msg::Student&gt;(<span class="string">"chatter_stu"</span>,<span class="number">10</span>,</span><br><span class="line">            std::<span class="built_in">bind</span>(&amp;ListenerStu::do_cb,<span class="keyword">this</span>,_1));</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">do_cb</span><span class="params">(<span class="type">const</span> base_interfaces::msg::Student &amp;stu)</span></span>{</span><br><span class="line">        <span class="comment">// 3-2.解析并输出数据</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"订阅的学生消息:name=%s,age=%d,height=%.2f"</span>,</span><br><span class="line">        stu.name.<span class="built_in">c_str</span>(),stu.age,stu.height);</span><br><span class="line">    }</span><br><span class="line">    rclcpp::Subscription&lt;base_interfaces::msg::Student&gt;::SharedPtr subcription_;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">    rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">    <span class="comment">// 4.调用spin函数，并传入节点对象指针</span></span><br><span class="line">    rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;ListenerStu&gt;());</span><br><span class="line">    <span class="comment">// 5.释放资源；</span></span><br><span class="line">    rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>编译执行即可</p>
<h3 id="服务通信"><a href="#服务通信" class="headerlink" title="服务通信"></a>服务通信</h3><p>服务通信也是ROS中一种极其常用的通信模式，服务通信是基于<strong>请求响应</strong>模式的，是一种应答机制</p>
<blockquote>
<p>一个节点A向另一个节点B发送请求，B接收处理请求并产生响应结果返回给A</p>
</blockquote>
<p>服务通信更适用于对实时性有要求、具有一定逻辑处理的应用场景</p>
<p>发送请求数据的对象称为客户端，接收请求并发送响应的对象称之为服务端，同话题通信一样，客户端和服务端也通过话题相关联，不同的是服务通信的数据传输是双向交互式的</p>
<p>一般是一对多的关系(一个服务器，多个服务端)</p>
<img src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/YJS1/2.3服务通信模型2 (1).gif" alt="2.3服务通信模型2 (1)" style="zoom:80%;">

<h4 id="案例需求-1"><a href="#案例需求-1" class="headerlink" title="案例需求"></a>案例需求</h4><p>需求：编写服务通信，客户端可以提交两个整数到服务端，服务端接收请求并解析两个整数求和，然后将结果响应回客户端</p>
<p>终端下进入工作空间的src目录，调用命令创建C++功能包，同时创建一个cpp文件</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create cpp02_service --build-type ament_cmake --dependencies rclcpp base_interfaces --node-name demo01_server</span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置接口消息-1"><a href="#配置接口消息-1" class="headerlink" title="配置接口消息"></a>配置接口消息</h4><p><strong>创建并编辑 .srv 文件</strong></p>
<p>功能包base_interfaces下新建srv文件夹，srv文件夹下新建AddInts.srv文件，文件中输入如下内容：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int32 num1</span><br><span class="line">int32 num2</span><br><span class="line">---</span><br><span class="line">int32 sum</span><br></pre></td></tr></tbody></table></figure>

<p><strong>编辑配置文件</strong></p>
<p>srv文件与msg文件的包依赖一致</p>
<p>如果是新建的功能包添加srv文件，那么直接参考定义msg文件时package.xml 配置即可</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 编译依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>rosidl_default_generators<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 执行依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>rosidl_default_runtime<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 声明当前包所属的功能包组 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">member_of_group</span>&gt;</span>rosidl_interface_packages<span class="tag">&lt;/<span class="name">member_of_group</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>由于使用的同一个工作空间，无需修改</p>
<p>为了将<code>.srv</code>文件转换成对应的C++和Python代码，还需要在CMakeLists.txt中添加如下配置</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">find_package(rosidl_default_generators REQUIRED) # 添加依赖</span><br><span class="line">rosidl_generate_interfaces(${PROJECT_NAME}</span><br><span class="line">  "msg/Student.msg"</span><br><span class="line">  "srv/AddInts.srv" # 增添部分</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p><strong>编译</strong></p>
<p>终端中进入当前工作空间，编译功能包</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">colcon build --packages-select base_interfaces</span><br></pre></td></tr></tbody></table></figure>

<p><strong>测试</strong></p>
<p>编译完成之后，在工作空间下的 install 目录下将生成<code>AddInts.srv</code>文件对应的C++和Python文件</p>
<p>可以在终端下进入工作空间，通过如下命令查看文件定义以及编译是否正常</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">. install/setup.bash</span><br><span class="line">ros2 interface show base_interfaces/srv/AddInts</span><br></pre></td></tr></tbody></table></figure>

<p>正常情况下，终端将会输出与<code>AddInts.srv</code>文件一致的内容</p>
<h4 id="案例实现"><a href="#案例实现" class="headerlink" title="案例实现"></a>案例实现</h4><p>CMakeLists配置参考话题通信</p>
<p><strong>服务端实现</strong></p>
<p>功能包cpp02_service的src目录下</p>
<p>demo01_server.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">  需求：编写服务端，接收客户端发送请求，提取其中两个整型数据，相加后将结果响应回客户端。</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建服务端；</span></span><br><span class="line"><span class="comment">      3-2.处理请求数据并响应结果。</span></span><br><span class="line"><span class="comment">    4.调用spin函数，并传入节点对象指针；</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/srv/add_ints.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> base_interfaces::srv::AddInts;</span><br><span class="line"><span class="keyword">using</span> std::placeholders::_1;</span><br><span class="line"><span class="keyword">using</span> std::placeholders::_2;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddIntsServer</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">AddIntsServer</span>():<span class="built_in">Node</span>(<span class="string">"addints_server_node_cpp"</span>){ </span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"服务端创建成功！"</span>);</span><br><span class="line">    <span class="comment">// 3-1.创建服务端；</span></span><br><span class="line">    <span class="comment">/* 模板：服务接口类型;</span></span><br><span class="line"><span class="comment">	     参数:</span></span><br><span class="line"><span class="comment">		    1.服务话题;</span></span><br><span class="line"><span class="comment">		    2.回调函数。</span></span><br><span class="line"><span class="comment">	     返回值：服务对象指针</span></span><br><span class="line"><span class="comment">	  */</span></span><br><span class="line">    server = <span class="keyword">this</span>-&gt;<span class="built_in">create_service</span>&lt;AddInts&gt;(<span class="string">"add_ints"</span>,</span><br><span class="line">        std::<span class="built_in">bind</span>(&amp;AddIntsServer::add,<span class="keyword">this</span>,_1,_2));</span><br><span class="line">  }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// 3-2.处理请求数据并响应结果。</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">const</span> AddInts::Request::SharedPtr req,<span class="type">const</span> AddInts::Response::SharedPtr res)</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    res-&gt;sum = req-&gt;num1 + req-&gt;num2;</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"请求数据:(%d,%d),响应结果:%d"</span>, req-&gt;num1, req-&gt;num2, res-&gt;sum);</span><br><span class="line">  }</span><br><span class="line">  rclcpp::Service&lt;AddInts&gt;::SharedPtr server;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数，并传入节点类对象；</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;AddIntsServer&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>验证实现：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 service call /add_ints base_interfaces/srv/AddInts "{'num1':10,'num2':2}"</span><br></pre></td></tr></tbody></table></figure>

<p>/add_ints是服务的话题名称，后面跟数据类型，可以[TAB]查看</p>
<p>输入参数的写法需要注意</p>
<p><strong>客户端实现</strong></p>
<p>注意客户端不需要挂起，不需要spin</p>
<p>功能包cpp02_service的src目录下</p>
<p>demo02_client.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">  需求：编写客户端，发送两个整型变量作为请求数据，并处理响应结果。</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    前提：main中需要验证提交参数是否正确</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建客户端；</span></span><br><span class="line"><span class="comment">      3-2.等待服务连接；</span></span><br><span class="line"><span class="comment">      3-3.组织请求数据并发送；</span></span><br><span class="line"><span class="comment">    4.创建对象指针调用其功能</span></span><br><span class="line"><span class="comment">      调用连接服务函数，根据连接结果进行下一步</span></span><br><span class="line"><span class="comment">      连接成功后，调用请求发送函数</span></span><br><span class="line"><span class="comment">      处理响应结果</span></span><br><span class="line"><span class="comment">    5.释放资源</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/srv/add_ints.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> base_interfaces::srv::AddInts;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals; <span class="comment">// 可以直接输入时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddIntsClient</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">AddIntsClient</span>():<span class="built_in">Node</span>(<span class="string">"addints_client_node_cpp"</span>){  </span><br><span class="line">	  <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"客户端创建成功！"</span>); </span><br><span class="line">    <span class="comment">// 3-1.创建客户端</span></span><br><span class="line">    client_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_client</span>&lt;AddInts&gt;(<span class="string">"add_ints"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 3-2.等待服务连接；</span></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">connect_server</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="comment">// 循环以5s时间连接服务器，直到服务器连接成功</span></span><br><span class="line">      <span class="keyword">while</span>(!client_-&gt;<span class="built_in">wait_for_service</span>(<span class="number">5</span>s)) <span class="comment">// 连接上返回true，超过时间返回false</span></span><br><span class="line">      {</span><br><span class="line">        <span class="comment">// 对ctrl+c作出特殊处理</span></span><br><span class="line">        <span class="comment">// 按下ctrl+c是结束R0S2程序，意味着要释放资源，例如关闭context，无法再调用类this</span></span><br><span class="line">        <span class="comment">// rclcpp::get_logger("name")创建 logger 对象不依赖于context</span></span><br><span class="line">        <span class="keyword">if</span> (!rclcpp::<span class="built_in">ok</span>())</span><br><span class="line">        {</span><br><span class="line">          <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"强制退出！"</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"服务连接中，请稍候..."</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-3.组织请求数据并发送；</span></span><br><span class="line">    <span class="comment">//编写发送请求函数，参数是两个整型数据，返回值是提交请求后服务端的返回结果</span></span><br><span class="line">    rclcpp::Client&lt;AddInts&gt;::<span class="function">FutureAndRequestId <span class="title">send_request</span><span class="params">(<span class="type">int32_t</span> num1,<span class="type">int32_t</span> num2)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">auto</span> request = std::<span class="built_in">make_shared</span>&lt;AddInts::Request&gt;();</span><br><span class="line">      request-&gt;num1 = num1;</span><br><span class="line">      request-&gt;num2 = num2;</span><br><span class="line">      <span class="keyword">return</span> client_-&gt;<span class="built_in">async_send_request</span>(request);</span><br><span class="line">      <span class="comment">// async_send_request返回: a FutureAndRequestId instance.</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  rclcpp::Client&lt;AddInts&gt;::SharedPtr client_;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">if</span>(argc!=<span class="number">3</span>)</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">RCLCPP_ERROR</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"请提交两个int数据"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 客户端不需要spin</span></span><br><span class="line">  <span class="comment">// 3-1 创建客户端对象</span></span><br><span class="line">  <span class="keyword">auto</span> client = std::<span class="built_in">make_shared</span>&lt;AddIntsClient&gt;(); </span><br><span class="line">  <span class="comment">// 根据连接结果做进一步处理</span></span><br><span class="line">  <span class="type">bool</span> flag = client-&gt;<span class="built_in">connect_server</span>();</span><br><span class="line">  <span class="keyword">if</span>(!flag)</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">RCLCPP_ERROR</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"服务器连接失败"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 调用请求提交函数，接收并处理响应结果。</span></span><br><span class="line">  <span class="comment">// 发送异步请求</span></span><br><span class="line">  <span class="keyword">auto</span> response = client-&gt;<span class="built_in">send_request</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>]),<span class="built_in">atoi</span>(argv[<span class="number">2</span>]));</span><br><span class="line">  <span class="comment">// 处理响应</span></span><br><span class="line">  <span class="comment">// 判断是否成功</span></span><br><span class="line">  <span class="keyword">if</span> (rclcpp::<span class="built_in">spin_until_future_complete</span>(client,response) == rclcpp::FutureReturnCode::SUCCESS)</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(client-&gt;<span class="built_in">get_logger</span>(),<span class="string">"请求正常处理"</span>);</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(client-&gt;<span class="built_in">get_logger</span>(),<span class="string">"响应结果:%d!"</span>, response.<span class="built_in">get</span>()-&gt;sum);</span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(client-&gt;<span class="built_in">get_logger</span>(),<span class="string">"请求异常"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="动作通信"><a href="#动作通信" class="headerlink" title="动作通信"></a>动作通信</h3><p>导航是一个过程，是耗时操作，如果使用服务通信，那么只有在导航结束时，才会产生响应结果，而在导航过程中，节点A是不会获取到任何反馈的，从而可能出现程序”假死”的现象</p>
<p>更合理的方案应该是：导航过程中，可以连续反馈当前机器人状态信息，当导航终止时，再返回最终的执行结果</p>
<p>在ROS中，该实现策略称为action 通信，适用于耗时的请求响应场景，用以获取连续的状态反馈</p>
<p>功能而言动作通信类似于服务通信，动作客户端可以发送请求到动作服务端，并接收动作服务端响应的最终结果，不过动作通信可以在请求响应过程中获取连续反馈，并且也可以向动作服务端发送任务取消请求</p>
<p>底层实现而言动作通信是建立在话题通信和服务通信之上的，目标发送实现是对服务通信的封装，结果的获取也是对服务通信的封装，而连续反馈则是对话题通信的封装</p>
<img src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/YJS1/2.4action通信模型 (1).gif" alt="2.4action通信模型 (1)" style="zoom: 80%;">

<h4 id="案例需求-2"><a href="#案例需求-2" class="headerlink" title="案例需求"></a>案例需求</h4><p>需求：编写动作通信，动作客户端提交一个整型数据N，动作服务端接收请求数据并累加1-N之间的所有整数，将最终结果返回给动作客户端，且每累加一次都需要计算当前运算进度并反馈给动作客户端</p>
<p>终端下进入工作空间的src目录，调用命令创建C++功能包</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create cpp03_action --build-type ament_cmake --dependencies rclcpp rclcpp_action base_interfaces --node-name demo01_action_server</span><br></pre></td></tr></tbody></table></figure>

<h4 id="配置接口消息-2"><a href="#配置接口消息-2" class="headerlink" title="配置接口消息"></a>配置接口消息</h4><p><strong>创建并编辑 .action 文件</strong></p>
<p>功能包base_interfaces下新建action文件夹，action文件夹下新建Progress.action文件，文件中输入如下内容</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int64 num</span><br><span class="line">---</span><br><span class="line">int64 sum</span><br><span class="line">---</span><br><span class="line">float64 progress</span><br></pre></td></tr></tbody></table></figure>

<p><strong>编辑配置文件</strong></p>
<p>如果单独构建action功能包，需要在package.xml中需要添加一些依赖包，具体内容如下：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;buildtool_depend&gt;rosidl_default_generators&lt;/buildtool_depend&gt;</span><br><span class="line">&lt;depend&gt;action_msgs&lt;/depend&gt;</span><br><span class="line">&lt;member_of_group&gt;rosidl_interface_packages&lt;/member_of_group&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>使用的是之前的包，已经为 msg 、srv 文件添加过了一些依赖，所以 package.xml 中添加如下内容即可</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;buildtool_depend&gt;rosidl_default_generators&lt;/buildtool_depend&gt;</span><br><span class="line">&lt;depend&gt;action_msgs&lt;/depend&gt;</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>注意，和之前的是有差异的，之前是<code>  &lt;build_depend&gt;rosidl_default_generators&lt;/build_depend&gt;</code></p>
</blockquote>
<p>为了将<code>.action</code>文件转换成对应的C++和Python代码，还需要在CMakeLists.txt 中添加如下配置：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">find_package(rosidl_default_generators REQUIRED) # 添加依赖</span><br><span class="line"></span><br><span class="line">rosidl_generate_interfaces(${PROJECT_NAME}</span><br><span class="line">  "msg/Student.msg"</span><br><span class="line">  "srv/AddInts.srv"</span><br><span class="line">  "action/Progress.action" # 增添的部分</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p><strong>编译</strong></p>
<p>终端中进入当前工作空间，编译功能包</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">colcon build --packages-select base_interfaces</span><br></pre></td></tr></tbody></table></figure>

<p><strong>测试</strong></p>
<p>编译完成之后，在工作空间下的 install 目录下将生成<code>Progress.action</code>文件对应的C++和Python文件</p>
<p>也可以在终端下进入工作空间，通过如下命令查看文件定义以及编译是否正常</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">. install/setup.bash</span><br><span class="line">ros2 interface show base_interfaces/action/Progress</span><br></pre></td></tr></tbody></table></figure>

<h4 id="案例实现-1"><a href="#案例实现-1" class="headerlink" title="案例实现"></a>案例实现</h4><p>CMakeLists配置参考话题通信</p>
<p><strong>动作服务端实现</strong></p>
<p>cpp03_action的src目录下</p>
<p>demo01_action_server.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">  需求：编写动作服务端，需要解析客户端提交的数字，遍历该数字并累加求和，最终结果响应回</span></span><br><span class="line"><span class="comment">       客户端，且请求响应过程中需要生成连续反馈。</span></span><br><span class="line"><span class="comment">  分析:</span></span><br><span class="line"><span class="comment">    1.创建动作服务端对象;</span></span><br><span class="line"><span class="comment">    2. 处理提交的目标值;</span></span><br><span class="line"><span class="comment">    3.生成连续反馈;</span></span><br><span class="line"><span class="comment">    4.响应最终结果；</span></span><br><span class="line"><span class="comment">    5.处理取消请求。</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建动作服务端对象；</span></span><br><span class="line"><span class="comment">      3-2.处理提交的目标值（回调函数）；</span></span><br><span class="line"><span class="comment">      3-3.处理取消请求（回调函数）</span></span><br><span class="line"><span class="comment">      3-4.生成连续反馈与最终响应（回调涵数）</span></span><br><span class="line"><span class="comment">    4.调用spin函数，并传入节点对象指针；</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp_action/rclcpp_action.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/action/progress.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> base_interfaces::action::Progress;</span><br><span class="line"><span class="keyword">using</span> std::placeholders::_1;</span><br><span class="line"><span class="keyword">using</span> std::placeholders::_2;</span><br><span class="line"><span class="comment">// using namespace std::placeholders; 或者直接这一句</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProgressActionServer</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ProgressActionServer</span>():<span class="built_in">Node</span>(<span class="string">"progressa_action_server_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">	<span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"action 服务端创建成功!"</span>);</span><br><span class="line">  <span class="comment">// 3-1.创建动作服务端对象；</span></span><br><span class="line">  <span class="comment">/* 参数列表</span></span><br><span class="line"><span class="comment">      (NodeT node, </span></span><br><span class="line"><span class="comment">      const std::string &amp;name, </span></span><br><span class="line"><span class="comment">      rclcpp_action::Server&lt;ActionT&gt;::GoalCallback handle_goal, </span></span><br><span class="line"><span class="comment">      rclcpp_action::Server&lt;ActionT&gt;::CancelCallback handle_cancel, </span></span><br><span class="line"><span class="comment">      rclcpp_action::Server&lt;ActionT&gt;::AcceptedCallback handle_accepted</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  server_ = rclcpp_action::<span class="built_in">create_server</span>&lt;Progress&gt;(</span><br><span class="line">      <span class="keyword">this</span>,</span><br><span class="line">      <span class="string">"get_sum"</span>,</span><br><span class="line">      std::<span class="built_in">bind</span>(&amp;ProgressActionServer::handle_goal,<span class="keyword">this</span>,_1,_2),</span><br><span class="line">      std::<span class="built_in">bind</span>(&amp;ProgressActionServer::handle_cancel,<span class="keyword">this</span>,_1),</span><br><span class="line">      std::<span class="built_in">bind</span>(&amp;ProgressActionServer::handle_accepted,<span class="keyword">this</span>,_1));</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"动作服务端创建，等待请求..."</span>);</span><br><span class="line">  }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  rclcpp_action::Server&lt;Progress&gt;::SharedPtr server_;</span><br><span class="line">  <span class="comment">// 3-2.处理提交的目标值（回调函数）；</span></span><br><span class="line">  <span class="comment">// GoalCallback =  std::function&lt;GoalResponse(const GoalUUID &amp;, std::shared_ptr&lt;const typename ActionT::Goal&gt;)&gt;;</span></span><br><span class="line">  <span class="function">rclcpp_action::GoalResponse <span class="title">handle_goal</span><span class="params">(<span class="type">const</span> rclcpp_action::GoalUUID &amp; uuid, std::shared_ptr&lt;<span class="type">const</span> Progress::Goal&gt; goal)</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    (<span class="type">void</span>)uuid; <span class="comment">// 标识目前没用上,避免警告</span></span><br><span class="line">    <span class="comment">// 业务逻辑：判断的端提交数字是否大于1，是接受，不是拒绝</span></span><br><span class="line">    <span class="keyword">if</span>(goal-&gt;num&lt;=<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"提交的目标值必须大于1"</span>);</span><br><span class="line">      <span class="keyword">return</span> rclcpp_action::GoalResponse::REJECT;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"提交目标成功"</span>);</span><br><span class="line">    <span class="keyword">return</span> rclcpp_action::GoalResponse::ACCEPT_AND_EXECUTE;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 3-3.处理取消请求（回调函数）</span></span><br><span class="line">  <span class="comment">// CancelCallback = std::function&lt;CancelResponse(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;</span></span><br><span class="line">  <span class="function">rclcpp_action::CancelResponse <span class="title">handle_cancel</span><span class="params">(std::shared_ptr&lt;rclcpp_action::ServerGoalHandle&lt;Progress&gt;&gt; goal_handle)</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    (<span class="type">void</span>)goal_handle;</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"接收到取消请求"</span>);</span><br><span class="line">    <span class="keyword">return</span> rclcpp_action::CancelResponse::ACCEPT;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3-4.生成连续反馈与最终响应（回调涵数）  </span></span><br><span class="line">  <span class="comment">// AcceptedCallback = std::function&lt;void (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">execute</span><span class="params">(std::shared_ptr&lt;rclcpp_action::ServerGoalHandle&lt;Progress&gt;&gt; goal_handle)</span></span>{</span><br><span class="line">    <span class="comment">// 1. 生成连续反馈</span></span><br><span class="line">    <span class="comment">// 首先要获取目标值，然后遍历，追历中进行累加，且每循环一次就计算进度，并作为连续反馈发布</span></span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"开始执行任务"</span>);</span><br><span class="line">    <span class="type">int</span> num = goal_handle-&gt;<span class="built_in">get_goal</span>()-&gt;num;</span><br><span class="line">    <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">double</span> progress = <span class="number">0.0</span>;</span><br><span class="line">    <span class="type">double</span> progress_pro;</span><br><span class="line">    <span class="comment">// void publish_feedback(std::shared_ptr&lt;base_interfaces::action::Progress_Feedback&gt; feedback_msg)</span></span><br><span class="line">    <span class="keyword">auto</span> feedback = std::<span class="built_in">make_shared</span>&lt;Progress::Feedback&gt;();</span><br><span class="line">    <span class="keyword">auto</span> result = std::<span class="built_in">make_shared</span>&lt;Progress::Result&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置休眠</span></span><br><span class="line">    <span class="function">rclcpp::Rate <span class="title">rate</span><span class="params">(<span class="number">1.0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= num; i++)</span><br><span class="line">    {</span><br><span class="line">      <span class="comment">// 检查取消请求</span></span><br><span class="line">      <span class="keyword">if</span> (goal_handle-&gt;<span class="built_in">is_canceling</span>()) {</span><br><span class="line">        result-&gt;sum = sum;</span><br><span class="line">		    <span class="comment">// void canceled(std::shared_ptr&lt;base_interfaces::action::Progress_Result&gt; result_msg)</span></span><br><span class="line">        goal_handle-&gt;<span class="built_in">canceled</span>(result);</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"任务取消!当前计算结果为%d"</span>, sum);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      }</span><br><span class="line">      sum += i; </span><br><span class="line">      progress = i/ (<span class="type">double</span>) num; <span class="comment">// 计算进度</span></span><br><span class="line">      feedback-&gt;progress = progress;</span><br><span class="line">      progress_pro = progress * <span class="number">100</span>;</span><br><span class="line">      goal_handle-&gt;<span class="built_in">publish_feedback</span>(feedback);</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"任务进行中，当前进度%.2f%%"</span>,progress_pro);</span><br><span class="line">      rate.<span class="built_in">sleep</span>();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 形成最终响应结果</span></span><br><span class="line">    <span class="comment">// void succeed(std::shared_ptr&lt;base_interfaces::action::Progress_Result&gt; result_msg)</span></span><br><span class="line">    <span class="keyword">if</span>(rclcpp::<span class="built_in">ok</span>())</span><br><span class="line">    {</span><br><span class="line">      result-&gt;sum = sum;</span><br><span class="line">      goal_handle-&gt;<span class="built_in">succeed</span>(result);</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"任务完成，最终结果:%d"</span>,sum);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">handle_accepted</span><span class="params">(std::shared_ptr&lt;rclcpp_action::ServerGoalHandle&lt;Progress&gt;&gt; goal_handle)</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    <span class="comment">// 新建线程处理耗时的主逻辑</span></span><br><span class="line">    std::thread{std::<span class="built_in">bind</span>(&amp;ProgressActionServer::execute,<span class="keyword">this</span>,_1),goal_handle}.<span class="built_in">detach</span>();</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数，并传入节点类对象；</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;ProgressActionServer&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>编写回调函数查看源码</p>
<p>create_server -&gt; Server</p>
</blockquote>
<p><strong>动作客户端实现</strong></p>
<p>cpp03_action的src目录下</p>
<p>demo02_action_client.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">  需求：编写动作客户端，可以发送一个整型数据到服务端，并处理服务端的连续反馈和最终响应结果。</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    前提：可以解析终端下动态传入的参数</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建动作客户端；</span></span><br><span class="line"><span class="comment">      3-2.发送请求;</span></span><br><span class="line"><span class="comment">      3-3.处理关于目标值的服务端响应（回调函数）</span></span><br><span class="line"><span class="comment">      3-4.处理连续反馈（回调函数）</span></span><br><span class="line"><span class="comment">      3-5.处理最终响应（回调函数）</span></span><br><span class="line"><span class="comment">    4.调用spin函数，并传入节点对象指针；</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp_action/rclcpp_action.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/action/progress.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> base_interfaces::action::Progress;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals; <span class="comment">// 可以直接输入时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProgressActionClient</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">ProgressActionClient</span>():<span class="built_in">Node</span>(<span class="string">"progress_action_client_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">	<span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"action 客户端创建成功!"</span>);</span><br><span class="line">  <span class="comment">// 3-1.创建动作客户端；</span></span><br><span class="line">  <span class="comment">/* 参数列表</span></span><br><span class="line"><span class="comment">  NodeT node, </span></span><br><span class="line"><span class="comment">  const std::string &amp;name</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  client_ = rclcpp_action::<span class="built_in">create_client</span>&lt;Progress&gt;(<span class="keyword">this</span>,<span class="string">"get_sum"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 3-2.发送请求;</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">send_goal</span><span class="params">(<span class="type">int</span> num)</span></span>{</span><br><span class="line">    <span class="comment">// 1.需要连接到服务端</span></span><br><span class="line">    <span class="keyword">if</span>(!client_-&gt;<span class="built_in">wait_for_action_server</span>(<span class="number">5</span>s))</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">RCLCPP_ERROR</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"服务器连接失败！"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 2. 发送具体请求</span></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    std::shared_future&lt;rclcpp_action::ClientGoalHandle&lt;base_interfaces::action::Progress&gt;::SharedPtr&gt; </span></span><br><span class="line"><span class="comment">    async_send_goal(</span></span><br><span class="line"><span class="comment">        const base_interfaces::action::Progress::Goal &amp;goal,</span></span><br><span class="line"><span class="comment">        const rclcpp_action::Client&lt;base_interfaces::action::Progress&gt;::SendGoalOptions &amp;options)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">auto</span> goal = Progress::<span class="built_in">Goal</span>();</span><br><span class="line">    goal.num = num;</span><br><span class="line">    rclcpp_action::Client&lt;Progress&gt;::SendGoalOptions options;</span><br><span class="line">    options.goal_response_callback = std::<span class="built_in">bind</span>(&amp;ProgressActionClient::goal_response_callback,<span class="keyword">this</span>,_1);</span><br><span class="line">    options.feedback_callback = std::<span class="built_in">bind</span>(&amp;ProgressActionClient::feedback_callback,<span class="keyword">this</span>,_1,_2);</span><br><span class="line">    options.result_callback = std::<span class="built_in">bind</span>(&amp;ProgressActionClient::result_callback,<span class="keyword">this</span>,_1);</span><br><span class="line">    <span class="keyword">auto</span> future = client_ -&gt; <span class="built_in">async_send_goal</span>(goal,options);</span><br><span class="line">  }</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">cancel_goal</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (client_) {</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"发送取消请求"</span>);</span><br><span class="line">      client_-&gt;<span class="built_in">async_cancel_all_goals</span>();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  rclcpp_action::Client&lt;Progress&gt;::SharedPtr client_;</span><br><span class="line">  <span class="comment">// 3-3.处理关于目标值的服务端响应（回调函数）</span></span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">    using GoalHandle = ClientGoalHandle&lt;ActionT&gt;;</span></span><br><span class="line"><span class="comment">    using GoalResponseCallback = std::function&lt;void (typename GoalHandle::SharedPtr)&gt;;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">goal_response_callback</span><span class="params">(rclcpp_action::ClientGoalHandle&lt;Progress&gt;::SharedPtr goal_handle)</span></span>{</span><br><span class="line">    <span class="keyword">if</span>(!goal_handle){</span><br><span class="line">      <span class="built_in">RCLCPP_ERROR</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"目标请求被服务端拒绝!"</span>);</span><br><span class="line">      rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">    } <span class="keyword">else</span>{</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"目标处理中!目标ID: %s"</span>,<span class="built_in">goal_uuid_to_string</span>(goal_handle-&gt;<span class="built_in">get_goal_id</span>()).<span class="built_in">c_str</span>());</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 3-4.处理连续反馈（回调函数）</span></span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">    using GoalHandle = ClientGoalHandle&lt;ActionT&gt;;</span></span><br><span class="line"><span class="comment">    using FeedbackCallback =</span></span><br><span class="line"><span class="comment">    std::function&lt;void (</span></span><br><span class="line"><span class="comment">        typename ClientGoalHandle&lt;ActionT&gt;::SharedPtr,</span></span><br><span class="line"><span class="comment">        const std::shared_ptr&lt;const Feedback&gt;)&gt;;</span></span><br><span class="line"><span class="comment">    using FeedbackCallback = typename GoalHandle::FeedbackCallback;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">feedback_callback</span><span class="params">(rclcpp_action::ClientGoalHandle&lt;Progress&gt;::SharedPtr goal_handle, <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> Progress::Feedback&gt; feedback)</span></span>{</span><br><span class="line">    (<span class="type">void</span>)goal_handle;</span><br><span class="line">    <span class="type">double</span> progress = feedback-&gt;progress;</span><br><span class="line">    <span class="type">double</span> progress_pro = progress * <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"当前进度:%.2f%%"</span>,progress_pro);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 3-5.处理最终响应（回调函数）</span></span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">    using ResultCallback = typename GoalHandle::ResultCallback;</span></span><br><span class="line"><span class="comment">    template&lt;typename ActionT&gt;</span></span><br><span class="line"><span class="comment">    class ClientGoalHandle { struct WrappedResult }</span></span><br><span class="line"><span class="comment">    using ResultCallback = std::function&lt;void (const WrappedResult &amp; result)&gt;;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">result_callback</span><span class="params">(<span class="type">const</span> rclcpp_action::ClientGoalHandle&lt;Progress&gt;::WrappedResult &amp; result)</span></span>{</span><br><span class="line">    <span class="comment">// result.code</span></span><br><span class="line">    <span class="comment">// 通过状态码判断结果状态</span></span><br><span class="line">    <span class="keyword">if</span>(result.code == rclcpp_action::ResultCode::SUCCEEDED)</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"最终结果:%ld"</span>,result.result-&gt;sum);</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span>(result.code == rclcpp_action::ResultCode::ABORTED)</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"任务被中止!"</span>);</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span>(result.code == rclcpp_action::ResultCode::CANCELED){</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"任务被取消!"</span>);</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">else</span>{</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"未知异常!"</span>);</span><br><span class="line">    }</span><br><span class="line">    rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将UUID转换为可读字符串</span></span><br><span class="line">  <span class="function">std::string <span class="title">goal_uuid_to_string</span><span class="params">(<span class="type">const</span> rclcpp_action::GoalUUID&amp; uuid)</span> </span>{</span><br><span class="line">      std::stringstream ss;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> byte : uuid) {</span><br><span class="line">          ss &lt;&lt; std::hex &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; std::<span class="built_in">setfill</span>(<span class="string">'0'</span>) &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(byte);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> ss.<span class="built_in">str</span>();</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">if</span>(argc!= <span class="number">2</span>)</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">RCLCPP_ERROR</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"请提交一个&gt;1的整型数据!"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数，并传入节点类对象；</span></span><br><span class="line">  <span class="keyword">auto</span> node = std::<span class="built_in">make_shared</span>&lt;ProgressActionClient&gt;();</span><br><span class="line">  node-&gt;<span class="built_in">send_goal</span>(<span class="built_in">atoi</span>(argv[<span class="number">1</span>]));</span><br><span class="line">  <span class="comment">// 添加键盘监听线程</span></span><br><span class="line">  <span class="function">std::thread <span class="title">input_thread</span><span class="params">([node]() {</span></span></span><br><span class="line"><span class="params"><span class="function">    RCLCPP_INFO(node-&gt;get_logger(), <span class="string">"按 'c' 键取消目标"</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">while</span> (rclcpp::ok()) {</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="type">char</span> c = std::cin.get();</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">if</span> (c == <span class="string">'c'</span> || c == <span class="string">'C'</span>) {</span></span></span><br><span class="line"><span class="params"><span class="function">        node-&gt;cancel_goal();</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">      }</span></span></span><br><span class="line"><span class="params"><span class="function">    }</span></span></span><br><span class="line"><span class="params"><span class="function">  })</span></span>;</span><br><span class="line">  input_thread.<span class="built_in">detach</span>();</span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(node); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>编写回调函数查看源码</p>
<p>SendGoalOptions</p>
</blockquote>
<h3 id="参数服务"><a href="#参数服务" class="headerlink" title="参数服务"></a>参数服务</h3><p>参数服务是以共享的方式实现不同节点之间数据交互的一种通信模式</p>
<p>保存参数的节点称之为参数服务端，调用参数的节点称之为参数客户端</p>
<p>参数客户端与参数服务端的交互是基于请求响应的，且参数通信的实现本质上对服务通信的进一步封装</p>
<p>参数服务保存的数据类似于编程中“全局变量”的概念，可以在不同的节点之间共享数据</p>
<h4 id="案例需求-3"><a href="#案例需求-3" class="headerlink" title="案例需求"></a>案例需求</h4><p>需求：在参数服务端设置一些参数，参数客户端访问服务端并操作这些参数</p>
<p>终端下进入工作空间的src目录，调用命令创建C++功能包</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create cpp04_param --build-type ament_cmake --dependencies rclcpp --node-name demo00_param</span><br></pre></td></tr></tbody></table></figure>

<h4 id="参数数据类型"><a href="#参数数据类型" class="headerlink" title="参数数据类型"></a>参数数据类型</h4><p>在ROS2中，参数由键、值和描述符三部分组成，其中键是字符串类型，值可以是bool、int64、float64、string、byte[]、bool[]、int64[]、float64[]、string[]中的任一类型，描述符默认情况下为空，但是可以设置参数描述、参数数据类型、取值范围或其他约束等信息</p>
<p>C++客户端对应的类是<code>rclcpp::Parameter</code></p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">  需求：</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1 参数对象创建</span></span><br><span class="line"><span class="comment">      3-2 参数对象解析</span></span><br><span class="line"><span class="comment">    4.调用spin函数，并传入节点对象指针；</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyParam</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">MyParam</span>():<span class="built_in">Node</span>(<span class="string">"my_param_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">	  <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"参数API创建成功!"</span>);</span><br><span class="line">    <span class="comment">// 3-1 参数对象创建</span></span><br><span class="line">    <span class="function">rclcpp::Parameter <span class="title">p1</span><span class="params">(<span class="string">"car"</span>,<span class="string">"tiger"</span>)</span></span>;</span><br><span class="line">    <span class="function">rclcpp::Parameter <span class="title">p2</span><span class="params">(<span class="string">"width"</span>,<span class="number">0.15</span>)</span></span>; <span class="comment">//参数值为浮点类型</span></span><br><span class="line">    <span class="function">rclcpp::Parameter <span class="title">p3</span><span class="params">(<span class="string">"wheels"</span>,<span class="number">2</span>)</span></span>; <span class="comment">//参数值为整型</span></span><br><span class="line">    <span class="comment">// 3-2 参数对象解析</span></span><br><span class="line">    <span class="comment">// 获取参数值</span></span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"car_name = %s"</span>, p<span class="number">1.</span><span class="built_in">as_string</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"car_width = %.2f"</span>, p<span class="number">2.</span><span class="built_in">as_double</span>());</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"wheels = %ld"</span>, p<span class="number">3.</span><span class="built_in">as_int</span>());</span><br><span class="line">    <span class="comment">// 获取参数键</span></span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"p1 name = %s"</span>,p<span class="number">1.</span><span class="built_in">get_name</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="comment">// 获取参数数据类型</span></span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"p1 type_name = %s"</span>, p<span class="number">1.</span><span class="built_in">get_type_name</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="comment">// 将参数值转换成字符串类型</span></span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"p2 value_to_msg = %s"</span>, p<span class="number">2.</span><span class="built_in">value_to_string</span>().<span class="built_in">c_str</span>());</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数，并传入节点类对象；</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;MyParam&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="案例实现-2"><a href="#案例实现-2" class="headerlink" title="案例实现"></a>案例实现</h4><p>packages.xml无需修改，配置CMakeList</p>
<p><strong>参数服务端</strong></p>
<p>cpp04_param的src目录下</p>
<p>demo01_param_server.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">  需求：</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">        3-1.声明参数；</span></span><br><span class="line"><span class="comment">        3-2.查询参数；</span></span><br><span class="line"><span class="comment">        3-3.修改参数；</span></span><br><span class="line"><span class="comment">        3-4.删除参数。</span></span><br><span class="line"><span class="comment">    4.调用spin函数，并传入节点对象指针；</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParamServer</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 允许删除 需要通过NodeOptions声明</span></span><br><span class="line">    <span class="built_in">ParamServer</span>():<span class="built_in">Node</span>(<span class="string">"param_server_node_cpp"</span>,rclcpp::<span class="built_in">NodeOptions</span>().<span class="built_in">allow_undeclared_parameters</span>(<span class="literal">true</span>)){  </span><br><span class="line">		<span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"参数服务器创建成功!"</span>);</span><br><span class="line">	}</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">declare_param</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"----------增加----------"</span>);</span><br><span class="line">        <span class="comment">// 声明参数并设置默认值</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">declare_parameter</span>(<span class="string">"car_name"</span>,<span class="string">"tiger"</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">declare_parameter</span>(<span class="string">"height"</span>,<span class="number">1.50</span>); </span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">declare_parameter</span>(<span class="string">"wheels"</span>,<span class="number">4</span>); </span><br><span class="line">        <span class="comment">// set_parameter才可删除</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">set_parameter</span>(rclcpp::<span class="built_in">Parameter</span>(<span class="string">"undcl_test"</span>,<span class="number">100</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">get_param</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"----------查询----------"</span>);</span><br><span class="line">        <span class="comment">// 指定查询</span></span><br><span class="line">        rclcpp::Parameter car_name = <span class="keyword">this</span>-&gt;<span class="built_in">get_parameter</span>(<span class="string">"car_name"</span>);</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"car_name:%s"</span>,car_name.<span class="built_in">as_string</span>().<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="comment">// 判断包含</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"包含car_name? %d"</span>,<span class="keyword">this</span>-&gt;<span class="built_in">has_parameter</span>(<span class="string">"car_name"</span>));</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"包含car_type? %d"</span>,<span class="keyword">this</span>-&gt;<span class="built_in">has_parameter</span>(<span class="string">"car_type"</span>));</span><br><span class="line">        <span class="comment">// 获取所有</span></span><br><span class="line">        <span class="keyword">auto</span> params = <span class="keyword">this</span>-&gt;<span class="built_in">get_parameters</span>({<span class="string">"car_name"</span>,<span class="string">"height"</span>,<span class="string">"wheels"</span>});</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;param : params)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"name = %s, value = %s"</span>, param.<span class="built_in">get_name</span>().<span class="built_in">c_str</span>(), param.<span class="built_in">value_to_string</span>().<span class="built_in">c_str</span>());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update_param</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"----------修改----------"</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">set_parameter</span>(rclcpp::<span class="built_in">Parameter</span>(<span class="string">"height"</span>,<span class="number">1.75</span>));</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">del_param</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"----------删除----------"</span>);</span><br><span class="line">        <span class="comment">//this-&gt;undeclare_parameter("car_name"); //会报错，无法删除</span></span><br><span class="line">        <span class="comment">// RCLCPP_INFO(this-&gt;get_logger(),"删除后还包含car_name吗? %d",this-&gt;has_parameter("car_name")); </span></span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">undeclare_parameter</span>(<span class="string">"undcl_test"</span>);</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"删除后还包含undcl_test吗? %d"</span>,<span class="keyword">this</span>-&gt;<span class="built_in">has_parameter</span>(<span class="string">"undcl_test"</span>)); </span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数，并传入节点类对象；</span></span><br><span class="line">  <span class="keyword">auto</span> paramServer = std::<span class="built_in">make_shared</span>&lt;ParamServer&gt;();</span><br><span class="line">  paramServer-&gt;<span class="built_in">declare_param</span>();</span><br><span class="line">  paramServer-&gt;<span class="built_in">get_param</span>();</span><br><span class="line">  paramServer-&gt;<span class="built_in">update_param</span>();</span><br><span class="line">  paramServer-&gt;<span class="built_in">del_param</span>();</span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(paramServer); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>参数客户端</strong></p>
<p>cpp04_param的src目录下</p>
<p>demo02_param_client.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需求：编写参数客户端，获取或修改服务端参数。</span></span><br><span class="line"><span class="comment">    步骤：</span></span><br><span class="line"><span class="comment">        1.包含头文件；</span></span><br><span class="line"><span class="comment">        2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">        3.定义节点类；</span></span><br><span class="line"><span class="comment">            3-1.创建参数客户端对象</span></span><br><span class="line"><span class="comment">            3-2.连接到客户端</span></span><br><span class="line"><span class="comment">            3-3.查询参数</span></span><br><span class="line"><span class="comment">            3-4.修改参数</span></span><br><span class="line"><span class="comment">        4.创建节点对象指针，调用参数操作函数；</span></span><br><span class="line"><span class="comment">        5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义类节点</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ParamClient</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ParamClient</span>():<span class="built_in">Node</span>(<span class="string">"param_client_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">		<span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"参数客户端创建成功!"</span>);</span><br><span class="line">    <span class="comment">// 3-1.创建参数客户端对象</span></span><br><span class="line">    <span class="comment">// 参数1: 当前对象节点 参数2: 远程连接节点</span></span><br><span class="line">    param_client = std::<span class="built_in">make_shared</span>&lt;rclcpp::SyncParametersClient&gt;(<span class="keyword">this</span>,<span class="string">"param_server_node_cpp"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-2.连接到客户端</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connect_server</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="keyword">while</span>(!param_client-&gt;<span class="built_in">wait_for_service</span>(<span class="number">5</span>s)){</span><br><span class="line">        <span class="keyword">if</span>(!rclcpp::<span class="built_in">ok</span>()){</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"服务连接中..."</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">get_param</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"-----------参数客户端查询参数-----------"</span>);</span><br><span class="line">      <span class="comment">// 获取某个参数</span></span><br><span class="line">      std::string car_name = param_client-&gt;<span class="built_in">get_parameter</span>&lt;std::string&gt;(<span class="string">"car_name"</span>);</span><br><span class="line">      <span class="type">double</span> height = param_client-&gt;<span class="built_in">get_parameter</span>&lt;<span class="type">double</span>&gt;(<span class="string">"height"</span>);</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"car_name=%s,height=%.2f"</span>,car_name.<span class="built_in">c_str</span>(),height);</span><br><span class="line">      <span class="comment">// 获取多个参数</span></span><br><span class="line">      <span class="keyword">auto</span> params = param_client-&gt;<span class="built_in">get_parameters</span>({<span class="string">"car_name"</span>,<span class="string">"height"</span>,<span class="string">"wheels"</span>});</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;&amp;param : params)</span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"%s = %s"</span>,param.<span class="built_in">get_name</span>().<span class="built_in">c_str</span>(),param.<span class="built_in">value_to_string</span>().<span class="built_in">c_str</span>());</span><br><span class="line">      }</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"包含car_name吗?%d"</span>,param_client-&gt;<span class="built_in">has_parameter</span>(<span class="string">"car_name"</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update_param</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"-----------参数客户端修改参数-----------"</span>);</span><br><span class="line">      param_client-&gt;<span class="built_in">set_parameters</span>({rclcpp::<span class="built_in">Parameter</span>(<span class="string">"car_name"</span>,<span class="string">"Mouse"</span>),</span><br><span class="line">      rclcpp::<span class="built_in">Parameter</span>(<span class="string">"height"</span>,<span class="number">2.0</span>),</span><br><span class="line">      rclcpp::<span class="built_in">Parameter</span>(<span class="string">"width"</span>,<span class="number">0.15</span>),  <span class="comment">// 设置一个不存在的参数，必须在参数服务端声明allow_undeclared_parameters(true)</span></span><br><span class="line">      rclcpp::<span class="built_in">Parameter</span>(<span class="string">"wheels"</span>,<span class="number">6</span>)});</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"新设置的参数:%.2f"</span>,param_client-&gt;<span class="built_in">get_parameter</span>&lt;<span class="type">double</span>&gt;(<span class="string">"width"</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  rclcpp::SyncParametersClient::SharedPtr param_client;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数，并传入节点类对象；</span></span><br><span class="line">  <span class="keyword">auto</span> client = std::<span class="built_in">make_shared</span>&lt;ParamClient&gt;();</span><br><span class="line">  <span class="type">bool</span> flag = client-&gt;<span class="built_in">connect_server</span>();</span><br><span class="line">  <span class="keyword">if</span>(!flag){</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  }</span><br><span class="line">  client-&gt;<span class="built_in">get_param</span>();</span><br><span class="line">  client-&gt;<span class="built_in">update_param</span>();</span><br><span class="line">  client-&gt;<span class="built_in">get_param</span>();</span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>问题：服务通信不是通过服务话题关联吗？为什么参数客户端是通过参数服务端的节点名称关联？</p>
<ol>
<li>参数服务端启动后，底层封装了多个服务通信的服务端；</li>
<li>每个服务端的话题，都是采用/服务端节点名称/XXXX;</li>
<li>参数客户端创建后，也会封装多个服务通信的客户端；</li>
<li>这些客户端与服务端相呼应，也要使用相同的话题，因此客户端再创建时需要使用服务端节点名称</li>
</ol>
<h3 id="本章小节"><a href="#本章小节" class="headerlink" title="本章小节"></a>本章小节</h3><p>无论何种通信机制，实现框架都是类似的</p>
<p>比如：通信必然涉及到双方，双方需要通过“话题”关联，通信还都必然涉及到数据，一般可以通过接口文件来定义数据格式</p>
<p>不同的通信机制其实现模型也存在明显差异</p>
<ul>
<li>话题通信是基于广播的单向数据交互模式</li>
<li>服务通信是基于请求响应的问答式交数据互模式</li>
<li>动作通信则是在请求响应的过程中又包含连续反馈的数据交互模式</li>
<li>参数服务是基于服务通信的，可以在不同节点间实现数据共享</li>
</ul>
<h2 id="ROS2通信机制补充"><a href="#ROS2通信机制补充" class="headerlink" title="ROS2通信机制补充"></a>ROS2通信机制补充</h2><p>ROS2程序构建时可能遇到的问题：</p>
<ol>
<li>怎么实现分布式架构？</li>
<li>不同工作空间下的功能包重名时会出现什么问题？</li>
<li>怎么管理功能包？</li>
<li>节点重名怎么处理？</li>
<li>话题重名怎么处理？</li>
</ol>
<h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><p>分布式通信是指可以通过网络在不同主机之间实现数据交互的一种通信策略</p>
<p>ROS2所基于的中间件是DDS，当处于同一网络中时，通过DDS的域ID机制(ROS_DOMAIN_ID)可以实现分布式</p>
<p>大致流程：在启动节点之前，可以设置域ID的值，不同节点如果域ID相同，那么可以自由发现并通信</p>
<p>默认情况下，所有节点启动时所使用的域ID为0，换言之，只要保证在同一网络，不需要做任何配置，不同ROS2设备上的不同节点即可实现分布式通信</p>
<p>如果要将不同节点划分为多个组，那么可以在终端中启动节点前设置该节点的域ID(比如设置为6)，具体执行命令为：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export ROS_DOMAIN_ID=6</span><br></pre></td></tr></tbody></table></figure>

<p>上述指令执行后，该节点将被划分到ID为6的域内</p>
<p>如果要为当前设备下的所有节点设置统一的域ID，那么可以执行如下指令</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "export ROS_DOMAIN_ID=6" &gt;&gt; ~/.bashrc</span><br></pre></td></tr></tbody></table></figure>

<p>执行完毕后再重新启动终端，运行的所有节点将自动被划分到ID为6的域内</p>
<p><strong>注意</strong></p>
<p>在设置ROS_DOMAIN_ID的值时并不是随意的，也是有一定约束的：</p>
<ol>
<li>建议ROS_DOMAIN_ID的取值在[0,101] 之间，包含0和101；</li>
<li>每个域ID内的节点总数是有限制的，需要小于等于120个；</li>
<li>如果域ID为101，那么该域的节点总数需要小于等于54个</li>
</ol>
<p><strong>DDS 域 ID 值的计算规则</strong>(补充内容)</p>
<p>DDS是基于TCP/IP或UDP/IP网络通信协议的，网络通信时需要指定端口号，端口号由2个字节的无符号整数表示，其取值范围在[0,65535]之间</p>
<p>端口号的分配也是有其规则的，并非可以任意使用的，根据DDS协议规定<font color="Violetred">以7400作为起始端口</font>，也即可用端口为[7400,65535]，又已知按照DDS协议默认情况下，<font color="Violetred">每个域ID占用250个端口</font>，那么域ID的个数为：(65535-7400)/250 = 232(个)，对应的其取值范围为[0,231]</p>
<p>操作系统还会设置一些预留端口，在DDS中使用端口时，还需要避开这些预留端口，以免使用中产生冲突，不同的操作系统预留端口又有所差异，其最终结果是，在Linux下，可用的域ID为[0,101]与[215-231]，在Windows和Mac中可用的域ID为[0,166]</p>
<p>综上，为了兼容多平台，建议<font color="Violetred">域ID在[0,101] 范围内取值</font></p>
<p>每个域ID默认占用250个端口，且每个ROS2节点需要占用两个端口，另外，按照DDS协议每个域ID的端口段内，第1、2个端口是Discovery Multicast端口与User Multicast端口，从第11、12个端口开始是域内第一个节点的Discovery Unicast端口与User Unicast，后续节点所占用端口依次顺延，那么一个域ID中的最大节点个数为：(250-10)/2 = 120(个)</p>
<p>特殊情况：域ID值为101时，其后半段端口属于操作系统的预留端口，其节点最大个数为54个</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">域 ID 与节点所占用端口示意</span><br><span class="line"></span><br><span class="line">Domain ID:      0</span><br><span class="line">Participant ID: 0</span><br><span class="line"></span><br><span class="line">Discovery Multicast Port: 7400</span><br><span class="line">User Multicast Port:      7401</span><br><span class="line">Discovery Unicast Port:   7410</span><br><span class="line">User Unicast Port:        7411</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">Domain ID:      1</span><br><span class="line">Participant ID: 2</span><br><span class="line">Discovery Multicast Port: 7650</span><br><span class="line">User Multicast Port:      7651</span><br><span class="line">Discovery Unicast Port:   7664</span><br><span class="line">User Unicast Port:        7665</span><br><span class="line"></span><br><span class="line"># 第1个域+250 节点ID为2-&gt;第三个节点 7660开始 (7660 7661) (7662 7663) (7664 7665) </span><br></pre></td></tr></tbody></table></figure>

<h3 id="工作空间覆盖"><a href="#工作空间覆盖" class="headerlink" title="工作空间覆盖"></a>工作空间覆盖</h3><p>同一工作空间下不允许出现功能包重名的情况，但是当存在多个工作空间时，不同工作空间下的功能包是可以重名的，那么当功能包重名时，会调用哪一个呢？</p>
<p>所谓工作空间覆盖，是指不同工作空间存在重名功能包时，重名功能包的调用会产生覆盖的情况，<font color="Violetred">需要极力避免</font></p>
<p><strong>演示</strong></p>
<p>在不同的工作空间下创建turtlesim功能包</p>
<p>ws00_helloworld -&gt; turtlesim_node |  ws01_plumbing -&gt; turtlesim_node</p>
<p>在 ~/.bashrc 文件下追加如下内容</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source /home/ros2/ws00_helloworld/install/setup.bash</span><br><span class="line">source /home/ros2/ws01_plumbing/install/setup.bash</span><br></pre></td></tr></tbody></table></figure>

<p>新建终端运行 ros2 run turtlesim turtlesim_node</p>
<p>会发现执行的是 ws01_plumbing 功能包下的 turtlesim</p>
<p>这与~/.bashrc中不同工作空间的setup.bash文件的加载顺序有关：</p>
<ol>
<li>ROS2 会解析 ~/.bashrc 文件，并生成全局环境变量 AMENT_PREFIX_PATH 与 PYTHONPATH，两个环境变量取值分别对应了 ROS2 中 C++ 和 Python 功能包，环境变量的值由功能包名称组成</li>
<li><font color="Violetred">对于自定义的工作空间而言，后加载的配置文件优先级更高，后配置的工作空间的功能包在环境变量值组成的前部，但是ROS2系统的setup.bash文件不适用此规则，无论该文件在哪加载，优先级始终最低</font></li>
<li>调用功能包时，会按照 AMENT_PREFIX_PATH 或 PYTHONPATH 中包配置顺序从前往后依次查找相关功能包，查找到功能包时会停止搜索</li>
</ol>
<p><strong>隐患</strong></p>
<ol>
<li>可能会出现功能包调用混乱，出现实际调用与预期调用结果不符的情况；</li>
<li>即便可以通过 ~/.bashrc 来配置不同工作空间的优先级，但是经过测试，修改 ~/.bashrc 文件之后不一定马上生效，还需要删除工作空间下build与install目录重新编译，才能生效，这个过程繁琐且有不确定性</li>
</ol>
<h3 id="元功能包"><a href="#元功能包" class="headerlink" title="元功能包"></a>元功能包</h3><p>在ROS2中，提供了一种方式可以将不同的功能包打包成一个功能包，当安装某个功能模块时，直接调用打包后的功能包即可，该包又称之为元功能包(metapackage)</p>
<p>例如：<code>sudo apt install ros-&lt;ros2-distro&gt;-desktop</code> 命令安装 ros2 时就使用了元功能包，该元功能包依赖于 ROS2 中的其他一些功能包，安装该包时会一并安装依赖</p>
<p>新建一个功能包</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create tutorails_plumbing</span><br></pre></td></tr></tbody></table></figure>

<p>修改 package.xml 文件，添加执行时所依赖的包：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>base_interfaces<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>cpp01_topic<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>cpp02_service<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>cpp03_action<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>cpp04_param<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>通过这个方法可以学习如何查看别人的包</p>
<h3 id="节点重名"><a href="#节点重名" class="headerlink" title="节点重名"></a>节点重名</h3><p>由于节点名称一致，虽然实际有多个节点但是在计算图上显示一个，并且节点名称也会和话题名称、服务名称、动作名称、参数等产生关联，届时也可能会导致通信逻辑上的混乱</p>
<p>避免重名问题，一般有两种策略：</p>
<ol>
<li>名称重映射，也即为节点起别名；</li>
<li>命名空间，是为节点名称添加前缀，可以有多级，格式：/xxx/yyy/zzz</li>
</ol>
<p>这也是在 ROS2 中解决重名问题的常用策略</p>
<p>上述两种策略的实现途径主要有如下三种：</p>
<ol>
<li>ros2 run 命令实现；</li>
<li>launch 文件实现；</li>
<li>编码实现</li>
</ol>
<h4 id="run2-run"><a href="#run2-run" class="headerlink" title="run2 run"></a>run2 run</h4><p><strong>设置命名空间</strong></p>
<p>语法：ros2 run 包名 节点名 –ros-args –remap __ns:=命名空间</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtlesim_node --ros-args --remap __ns:=/t1</span><br></pre></td></tr></tbody></table></figure>

<p><strong>名称重映射</strong></p>
<p>语法：</p>
<ul>
<li>ros2 run 包名 节点名 –ros-args –remap __name:=新名称</li>
<li>ros2 run 包名 节点名 –ros-args –remap __node:=新名称</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtlesim_node --ros-args --remap __name:=turtle1</span><br></pre></td></tr></tbody></table></figure>

<p><strong>命名空间与名称重映射叠加</strong></p>
<p>语法：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtlesim_node --ros-args --remap __ns:=/t1 --remap __name:=turtle1</span><br></pre></td></tr></tbody></table></figure>

<h4 id="launch"><a href="#launch" class="headerlink" title="launch"></a>launch</h4><p>关于launch文件的基本使用可以参考launch部分</p>
<p><strong>python方式</strong></p>
<p>可以通过类 <code>launch_ros.actions.Node</code>来创建被启动的节点对象，在对象的构造函数中提供了 name 和 namespace 参数来设置节点的名称与命名空间，使用示例如下：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_launch_description</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> LaunchDescription([</span><br><span class="line">        Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>,name=<span class="string">"turtle1"</span>),</span><br><span class="line">        Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>,namespace=<span class="string">"t1"</span>),</span><br><span class="line">        Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>,namespace=<span class="string">"t1"</span>, name=<span class="string">"turtle1"</span>)</span><br><span class="line">    ])</span><br></pre></td></tr></tbody></table></figure>

<p><strong>XML方式</strong></p>
<p>可以通过 node 标签中 name 和 namespace 属性来设置节点的名称与命名空间，使用示例如下：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">"turtlesim"</span> <span class="attr">exec</span>=<span class="string">"turtlesim_node"</span> <span class="attr">name</span>=<span class="string">"turtle1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">"turtlesim"</span> <span class="attr">exec</span>=<span class="string">"turtlesim_node"</span> <span class="attr">namespace</span>=<span class="string">"t1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">"turtlesim"</span> <span class="attr">exec</span>=<span class="string">"turtlesim_node"</span> <span class="attr">namespace</span>=<span class="string">"t1"</span> <span class="attr">name</span>=<span class="string">"turtle1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>YAML方式</strong></p>
<p>可以通过 node 属性中 name 和 namespace 属性来设置节点的名称与命名空间，使用示例如下：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">launch:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">node:</span></span><br><span class="line">    <span class="attr">pkg:</span> <span class="string">turtlesim</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">turtlesim_node</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">turtle1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">node:</span></span><br><span class="line">    <span class="attr">pkg:</span> <span class="string">turtlesim</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">turtlesim_node</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">t1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">node:</span></span><br><span class="line">    <span class="attr">pkg:</span> <span class="string">turtlesim</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">turtlesim_node</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">t1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">turtle1</span></span><br></pre></td></tr></tbody></table></figure>

<p>运行方式</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 launch [包名] [可执行程序]</span><br></pre></td></tr></tbody></table></figure>

<h4 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h4><p>在 rclcpp 和 rclpy 中，节点类的构造函数中，都分别提供了设置节点名称与命名空间的参数</p>
<p>rclcpp中节点类的构造函数如下：</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Node</span> (<span class="type">const</span> std::string &amp;node_name, <span class="type">const</span> NodeOptions &amp;options=<span class="built_in">NodeOptions</span>())</span><br><span class="line"><span class="built_in">Node</span> (<span class="type">const</span> std::string &amp;node_name, <span class="type">const</span> std::string &amp;namespace_, <span class="type">const</span> NodeOptions &amp;options=<span class="built_in">NodeOptions</span>())</span><br></pre></td></tr></tbody></table></figure>

<p>构造函数1中可以直接通过node_name设置节点名称，构造函数2既可以通过node_name设置节点名称也可以通过namespace_设置命名空间</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MyNode</span>():<span class="built_in">Node</span>(<span class="string">"my_node_cpp"</span>,<span class="string">"ns"</span>)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="话题重名"><a href="#话题重名" class="headerlink" title="话题重名"></a>话题重名</h3><p>在 ROS2 不同的节点之间通信都依赖于话题，话题名称也可能出现重名的情况，话题重名时，系统虽然不会抛出异常，但是通过相同话题名称关联到一起的节点可能并不属于同一通信逻辑，从而导致通信错乱，甚至出现异常,这种情况下可能就需要将相同的话题名称设置为不同</p>
<p>又或者，两个节点是属于同一通信逻辑的，但是节点之间话题名称不同，导致通信失败。这种情况下就需要将两个节点的话题名称由不同修改为相同</p>
<p>与节点重名的解决思路类似的，为了避免话题重名问题，一般有两种策略：</p>
<ol>
<li>名称重映射，也即为话题名称起别名；</li>
<li>命名空间，是为话题名称添加前缀，可以有多级，格式：/xxx/yyy/zzz</li>
</ol>
<p><font color="Violetred">需要注意的是，通过命名空间设置话题名称时，需要保证话题是非全局话题</font></p>
<p>与节点重名解决方案类似的，修改话题名称的方式主要有如下三种：</p>
<ol>
<li>ros2 run 命令实现；</li>
<li>launch 文件实现；</li>
<li>编码实现</li>
</ol>
<h4 id="run2-run-1"><a href="#run2-run-1" class="headerlink" title="run2 run"></a>run2 run</h4><p><strong>设置命名空间</strong></p>
<p>该实现与节点重名的方法相同</p>
<p>语法：ros2 run 包名 节点名 –ros-args –remap __ns:=命名空间</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtlesim_node --ros-args --remap __ns:=/t1</span><br></pre></td></tr></tbody></table></figure>

<p><strong>话题名称重映射</strong></p>
<p>语法：ros2 run 包名 节点名 –ros-args –remap 原话题名称:=新话题名称</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 run turtlesim turtlesim_node --ros-args --remap /turtle1/cmd_vel:=/cmd_vel</span><br></pre></td></tr></tbody></table></figure>

<p>当为节点添加命名空间时，节点下的所有非全局话题都会前缀命名空间，而重映射的方式只是修改指定话题</p>
<h4 id="launch-1"><a href="#launch-1" class="headerlink" title="launch"></a>launch</h4><p><strong>python方式</strong></p>
<p>可以通过类 <code>launch_ros.actions.Node</code>的构造函数中的参数 remappings 修改话题名称，使用示例如下：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_launch_description</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> LaunchDescription([</span><br><span class="line">        Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>,namespace=<span class="string">"t1"</span>),</span><br><span class="line">        Node(package=<span class="string">"turtlesim"</span>,</span><br><span class="line">            executable=<span class="string">"turtlesim_node"</span>,</span><br><span class="line">            remappings=[(<span class="string">"/turtle1/cmd_vel"</span>,<span class="string">"/cmd_vel"</span>)]</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    ])</span><br></pre></td></tr></tbody></table></figure>

<p><strong>XML方式</strong></p>
<p>通过 node 标签的子标签 remap（属性from取值为被修改的话题名称，属性to的取值为修改后的话题名称） 修改话题名称</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">launch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">"turtlesim"</span> <span class="attr">exec</span>=<span class="string">"turtlesim_node"</span> <span class="attr">namespace</span>=<span class="string">"t1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">node</span> <span class="attr">pkg</span>=<span class="string">"turtlesim"</span> <span class="attr">exec</span>=<span class="string">"turtlesim_node"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">remap</span> <span class="attr">from</span>=<span class="string">"/turtle1/cmd_vel"</span> <span class="attr">to</span>=<span class="string">"/cmd_vel"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">launch</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>YAML方式</strong></p>
<p>通过 node 属性中 remap（属性from取值为被修改的话题名称，属性to的取值为修改后的话题名称） 修改话题名称</p>
<figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">launch:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">node:</span></span><br><span class="line">    <span class="attr">pkg:</span> <span class="string">turtlesim</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">turtlesim_node</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">t1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">node:</span></span><br><span class="line">    <span class="attr">pkg:</span> <span class="string">turtlesim</span></span><br><span class="line">    <span class="attr">exec:</span> <span class="string">turtlesim_node</span></span><br><span class="line">    <span class="attr">remap:</span></span><br><span class="line">    <span class="bullet">-</span></span><br><span class="line">        <span class="attr">from:</span> <span class="string">"/turtle1/cmd_vel"</span></span><br><span class="line">        <span class="attr">to:</span> <span class="string">"/cmd_vel</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="编码-1"><a href="#编码-1" class="headerlink" title="编码"></a>编码</h4><p>话题名称大致可以分为三种类型:</p>
<ul>
<li>全局话题(话题参考ROS系统，与节点命名空间平级)；</li>
<li>相对话题(话题参考的是节点的命名空间，与节点名称平级)；</li>
<li>私有话题(话题参考节点名称，是节点名称的子级)</li>
</ul>
<p><strong>全局话题</strong></p>
<p>定义时以<code>/</code>开头的名称，和命名空间、节点名称无关</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publisher_ = this-&gt;create_publisher&lt;std_msgs::msg::String&gt;("/topic/chatter", 10);</span><br></pre></td></tr></tbody></table></figure>

<p>话题名称为 /topic/chatter，与命名空间 xxx 以及节点名称 yyy 无关</p>
<p><strong>相对话题</strong></p>
<p>非<code>/</code>开头的名称，参考命名空间设置话题名称，和节点名称无关</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publisher_ = this-&gt;create_publisher&lt;std_msgs::msg::String&gt;("topic/chatter", 10);</span><br></pre></td></tr></tbody></table></figure>

<p>话题名称为 /xxx/topic/chatter，与命名空间 xxx 有关，与节点名称 yyy 无关</p>
<p><strong>私有话题</strong></p>
<p>以<code>~/</code>开头的名称，和命名空间、节点名称都有关系</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publisher_ = this-&gt;create_publisher&lt;std_msgs::msg::String&gt;("~/topic/chatter", 10);</span><br></pre></td></tr></tbody></table></figure>

<p>话题名称为 /xxx/yyy/topic/chatter，使用命名空间 xxx 以及节点名称 yyy 作为话题名称前缀</p>
<p>话题名称设置规则在rclcpp与rclpy中基本一致，且上述规则也同样适用于ros2 run指令与launch文件</p>
<h3 id="时间相关API"><a href="#时间相关API" class="headerlink" title="时间相关API"></a>时间相关API</h3><h4 id="Rate"><a href="#Rate" class="headerlink" title="Rate"></a>Rate</h4><p>示例：周期性输出一段文本</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyNode</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyNode</span>():<span class="built_in">Node</span>(<span class="string">"time_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"创建成功!"</span>);</span><br><span class="line">        <span class="built_in">demo_rate</span>();</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">demo_rate</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="comment">// 1. 创建Rate对象</span></span><br><span class="line">      <span class="function">rclcpp::Rate <span class="title">rate</span><span class="params">(<span class="number">500</span>ms)</span></span>;  <span class="comment">// 设置时间间隔</span></span><br><span class="line">      <span class="comment">// rclcpp::Rate rate(1.0); // 设置频率，输入浮点型数据</span></span><br><span class="line">      <span class="comment">// 2. 调用Rate的sleep函数</span></span><br><span class="line">      <span class="keyword">while</span> (rclcpp::<span class="built_in">ok</span>())</span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"---------"</span>);</span><br><span class="line">        rate.<span class="built_in">sleep</span>();</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数,并传入节点类对象;</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;MyNode&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Time"><a href="#Time" class="headerlink" title="Time"></a>Time</h4><p>示例：</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyNode</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyNode</span>():<span class="built_in">Node</span>(<span class="string">"time_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"创建成功!"</span>);</span><br><span class="line">        <span class="comment">// demo_rate();</span></span><br><span class="line">        <span class="built_in">demo_time</span>();</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">demo_time</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="comment">// 1. 创建 Time 对象</span></span><br><span class="line">      <span class="function">rclcpp::Time <span class="title">t1</span><span class="params">(<span class="number">500000000L</span>)</span></span>; <span class="comment">// 0.5s</span></span><br><span class="line">      <span class="function">rclcpp::Time <span class="title">t2</span><span class="params">(<span class="number">2</span>,<span class="number">500000000L</span>)</span></span>; <span class="comment">// 2.5s</span></span><br><span class="line">      <span class="comment">// rclcpp::Time right_now = this-&gt;get_clock()-&gt;now();</span></span><br><span class="line">      rclcpp::Time right_now = <span class="keyword">this</span>-&gt;<span class="built_in">now</span>();</span><br><span class="line">      <span class="comment">// 2. 调用Time对象函数</span></span><br><span class="line">      <span class="comment">// 秒为单位的输出 和 纳秒为单位的输出</span></span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"s = %.2f, ns = %ld"</span>,t<span class="number">1.</span><span class="built_in">seconds</span>(),t<span class="number">1.</span><span class="built_in">nanoseconds</span>());  </span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"s = %.2f, ns = %ld"</span>,t<span class="number">2.</span><span class="built_in">seconds</span>(),t<span class="number">2.</span><span class="built_in">nanoseconds</span>());</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"s = %.2f, ns = %ld"</span>,right_now.<span class="built_in">seconds</span>(),right_now.<span class="built_in">nanoseconds</span>());</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数,并传入节点类对象;</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;MyNode&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>Time</code> 的典型场景</p>
<ul>
<li>为消息添加时间戳（如 <code>sensor_msgs/msg/Image</code> 的 <code>header.stamp</code>）</li>
<li>记录事件发生的具体时刻（如机器人到达某个位置的时间）</li>
</ul>
<h4 id="Duration"><a href="#Duration" class="headerlink" title="Duration"></a>Duration</h4><p>示例：</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyNode</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyNode</span>():<span class="built_in">Node</span>(<span class="string">"time_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"创建成功!"</span>);</span><br><span class="line">        <span class="comment">// demo_rate();</span></span><br><span class="line">        <span class="comment">// demo_time();</span></span><br><span class="line">        <span class="built_in">demo_duration</span>();</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">demo_duration</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="comment">// 1. 创建 Duraiton 对象</span></span><br><span class="line">      <span class="function">rclcpp::Duration <span class="title">du1</span><span class="params">(<span class="number">1</span>s)</span></span>; <span class="comment">// 1s</span></span><br><span class="line">      <span class="function">rclcpp::Duration <span class="title">du2</span><span class="params">(<span class="number">2</span>,<span class="number">500000000</span>)</span></span>; <span class="comment">// 2.5s</span></span><br><span class="line">      <span class="comment">// 2. 调用 Duration 函数</span></span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"s = %.2f, ns = %ld"</span>,du<span class="number">1.</span><span class="built_in">seconds</span>(),du<span class="number">1.</span><span class="built_in">nanoseconds</span>());</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"s = %.2f, ns = %ld"</span>,du<span class="number">2.</span><span class="built_in">seconds</span>(),du<span class="number">2.</span><span class="built_in">nanoseconds</span>());</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p><code>Duration</code> 的典型场景</p>
<ul>
<li>设置定时器周期</li>
<li>实现延时等待</li>
</ul>
<p>问题：Time与Duration有什么区别？</p>
<p>API使用类似，但二者有着本质区别：</p>
<p>rclcpp:Time t2(2,500000000L) –&gt; 指的是一个具体时刻(时间点)</p>
<p>rclcpp::Duration du2(2,500000000) –&gt; 指的是一个时间段</p>
<h4 id="运算"><a href="#运算" class="headerlink" title="运算"></a>运算</h4><p>Time ± Duration → Time：时间点加减时间段 → 新时间点</p>
<p>Time - Time → Duration：两个时间点相减 → 时间段</p>
<p>Duration ± Duration → Duration：时间段加减 → 新时间段</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyNode</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyNode</span>():<span class="built_in">Node</span>(<span class="string">"time_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"创建成功!"</span>);</span><br><span class="line">        <span class="comment">// demo_rate();</span></span><br><span class="line">        <span class="comment">// demo_time();</span></span><br><span class="line">        <span class="comment">// demo_duration();</span></span><br><span class="line">        <span class="built_in">demo_opt</span>();</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">demo_opt</span><span class="params">()</span></span>{</span><br><span class="line">      <span class="function">rclcpp::Time <span class="title">t1</span><span class="params">(<span class="number">10</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line">      <span class="function">rclcpp::Time <span class="title">t2</span><span class="params">(<span class="number">30</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">      <span class="function">rclcpp::Duration <span class="title">du1</span><span class="params">(<span class="number">8</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line">      <span class="function">rclcpp::Duration <span class="title">du2</span><span class="params">(<span class="number">17</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line">      <span class="comment">// 比较</span></span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"t1 &gt;= t2 ? %d"</span>,t1 &gt;= t2);</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"t1 &lt; t2 ? %d"</span>,t1 &lt; t2);</span><br><span class="line">      rclcpp::Duration du3 = t2 - t1;</span><br><span class="line">      rclcpp::Time t3 = t1 + du1;</span><br><span class="line">      rclcpp::Time t4 = t1 - du1;</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"t3 = %.2f"</span>,t<span class="number">3.</span><span class="built_in">seconds</span>());  </span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"t4 = %.2f"</span>,t<span class="number">4.</span><span class="built_in">seconds</span>()); </span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"du3 = %.2f"</span>,du<span class="number">3.</span><span class="built_in">seconds</span>()); </span><br><span class="line">      <span class="comment">// 比较</span></span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"du1 &gt;= du2 ? %d"</span>, du1 &gt;= du2);</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"du1 &lt; du2 ? %d"</span>, du1 &lt; du2);</span><br><span class="line">      <span class="comment">// 数学运算</span></span><br><span class="line">      rclcpp::Duration du4 = du1 * <span class="number">3.0</span>;</span><br><span class="line">      rclcpp::Duration du5 = du1 + du2;</span><br><span class="line">      rclcpp::Duration du6 = du1 - du2;</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"du4 = %.2f"</span>,du<span class="number">4.</span><span class="built_in">seconds</span>()); </span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"du5 = %.2f"</span>,du<span class="number">5.</span><span class="built_in">seconds</span>()); </span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(), <span class="string">"du6 = %.2f"</span>,du<span class="number">6.</span><span class="built_in">seconds</span>()); </span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<p>Duration 可以负数，但 Time 不可以负数</p>
<h3 id="通信机制工具"><a href="#通信机制工具" class="headerlink" title="通信机制工具"></a>通信机制工具</h3><p>在ROS2中，通信机制相关的工具有两种类型，分别是命令行工具和图形化工具（rqt）</p>
<p>前者是一系列终端命令的集合，后者则是ROS2基于QT框架，针对机器人开发的一系列可视化工具的集合</p>
<h4 id="命令工具"><a href="#命令工具" class="headerlink" title="命令工具"></a>命令工具</h4><p>关于命令的使用一般都会提供帮助文档</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令 -h -&gt; ros2 node -h</span><br><span class="line">命令 --help -&gt; ros2 node -help</span><br></pre></td></tr></tbody></table></figure>

<p>常用命令整合：</p>
<blockquote>
<p>ros2 interace 整合了rosmsg</p>
<p>ROS2 将消息、服务、动作等抽象为“接口”，简化工具链</p>
</blockquote>
<table>
<thead>
<tr>
<th>命令</th>
<th>参数</th>
</tr>
</thead>
<tbody><tr>
<td>ros2 node</td>
<td>info → 输出节点信息<br>list → 输出运行中的节点的列表</td>
</tr>
<tr>
<td>ros2 interace</td>
<td>list → 输出所有可用的接口消息<br>package → 输出指定功能包下的接口<br>packages → 输出全部包含接口消息的功能包<br>proto → 输出接口消息原型<br>show → 输出接口消息定义格式</td>
</tr>
<tr>
<td>ros2 topic</td>
<td>bw → 输出话题消息传输占用的带宽<br>delay → 输出带有 header 的话题延迟<br>echo → 输出某个话题下的消息<br>find → 根据类型查找话题<br>hz → 输出消息发布频率<br>info → 输出话题相关信息<br>list → 输出运行中的话题列表<br>pub → 向指定话题发布消息<br>type → 输出话题使用的接口类型</td>
</tr>
<tr>
<td>ros2 service</td>
<td>call → 向某个服务发送请求<br>find → 根据类型查找服务<br>list → 输出运行中的服务列表<br>type → 输出服务使用的接口类型</td>
</tr>
<tr>
<td>ros2 action</td>
<td>info → 输出指定动作的相关信息<br>list → 输出运行中的动作的列表<br>send_goal → 向指定动作发送请求</td>
</tr>
<tr>
<td>ros2 param</td>
<td>delete → 删除参数<br>describe → 输出参数的描述信息<br>dump → 将节点参数写入到磁盘文件<br>get → 获取某个参数<br>list → 输出可用的参数的列表<br>load → 从磁盘文件加载参数到节点<br>set → 设置参数</td>
</tr>
</tbody></table>
<h4 id="rqt工具箱"><a href="#rqt工具箱" class="headerlink" title="rqt工具箱"></a>rqt工具箱</h4><p>一般只要安装的是desktop版本就会默认安装rqt工具箱</p>
<p>常用的启动命令为：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rqt</span><br></pre></td></tr></tbody></table></figure>

<p>启动rqt之后，可以通过plugins添加所需的插件</p>
<p>可以在rqt中向话题发送消息</p>
<h2 id="ROS2通信机制实操"><a href="#ROS2通信机制实操" class="headerlink" title="ROS2通信机制实操"></a>ROS2通信机制实操</h2><p>终端下进入工作空间的src目录，调用如下命令创建C++功能包</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ros2 pkg create cpp07_exercise --build-type ament_cmake --dependencies rclcpp turtlesim base_interfaces geometry_msgs rclcpp_action</span><br></pre></td></tr></tbody></table></figure>

<h3 id="话题通信案例"><a href="#话题通信案例" class="headerlink" title="话题通信案例"></a>话题通信案例</h3><p>需求：启动两个turtlesim_node节点，节点2中的乌龟自动调头180°，可以通过键盘控制节点1中的乌龟运动，但是不能控制节点2的乌龟，需要自实现功能：可以根据乌龟1的速度生成并发布控制乌龟2运动的速度指令，最终两只乌龟做镜像运动</p>
<p>核心实现是如何订阅乌龟1的速度并生成发布控制乌龟2运动的速度指令的，并且该节点需要在掉头完毕后启动</p>
<p>package.xml文件无需修改</p>
<p>CMakeLists.txt中配置launch文件</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">install(TARGETS </span><br><span class="line">  test01_topic</span><br><span class="line">  DESTINATION lib/${PROJECT_NAME})</span><br><span class="line"># 增加</span><br><span class="line">install(DIRECTORY launch DESTINATION share/${PROJECT_NAME})</span><br></pre></td></tr></tbody></table></figure>

<p><strong>launch文件</strong></p>
<p>启动小乌龟节点，查看action类型</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ros2 action list</span><br><span class="line">ros2 action info /turtle1/rotate_absolute</span><br><span class="line">ros2 action send_goal /turtle1/rotate_absolute </span><br></pre></td></tr></tbody></table></figure>

<p>后面不清楚的就[TAB]补齐即可</p>
<p>明确在终端如何通过命令控制乌龟运动</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"><span class="keyword">from</span> launch.actions <span class="keyword">import</span> ExecuteProcess,RegisterEventHandler</span><br><span class="line"><span class="keyword">from</span> launch.event_handlers <span class="keyword">import</span> OnProcessExit</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_launch_description</span>():</span><br><span class="line">    <span class="comment"># 1. 启动两个turtlesim_node，其中一个设置命名空间</span></span><br><span class="line">    t1 = Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>)</span><br><span class="line">    t2 = Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>,namespace=<span class="string">"t2"</span>)</span><br><span class="line">    <span class="comment"># 2. 控制第二个乌龟掉头</span></span><br><span class="line">    rotate = ExecuteProcess(</span><br><span class="line">        cmd = [<span class="string">"ros2 action send_goal /t2/turtle1/rotate_absolute turtlesim/action/RotateAbsolute \"{'theta':3.14}\""</span>], <span class="comment"># 记得转义字符</span></span><br><span class="line">        output = <span class="string">"both"</span>,</span><br><span class="line">        shell = <span class="literal">True</span>  <span class="comment"># cmd当成终端指令执行</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># 3. 调用自定义的节点，并且节点调用顺序有要求</span></span><br><span class="line">    test01 = Node(package=<span class="string">"cpp07_exercise"</span>,executable=<span class="string">"test01_topic"</span>)</span><br><span class="line">    <span class="comment"># 4. 控制节点启动,需要通过注册事件完成</span></span><br><span class="line">    <span class="comment"># 创建事件注册对象，在对象中声明针对哪个目标节点，在哪个事件触发时，执行哪种操作</span></span><br><span class="line">    register_rotate_exit_event = RegisterEventHandler(</span><br><span class="line">        <span class="comment"># 创建一个新对象，监听rotate的启动，退出后启动test01</span></span><br><span class="line">        event_handler = OnProcessExit(</span><br><span class="line">            target_action=rotate, <span class="comment"># 目标节点</span></span><br><span class="line">            on_exit=test01) <span class="comment"># 触发事件</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> LaunchDescription([t1,t2,rotate,register_rotate_exit_event])</span><br></pre></td></tr></tbody></table></figure>

<p><strong>速度订阅与发布</strong></p>
<p>test01_topic.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  需求：订阅窗口1中乌龟的位姿信息，解析出线速度和角速度，生成控制窗口2乌龟运动的指令并发布</span></span><br><span class="line"><span class="comment">  明确：</span></span><br><span class="line"><span class="comment">      订阅话题：/turtle1/pose</span></span><br><span class="line"><span class="comment">      订阅消息：turtlesim/msg/Pose</span></span><br><span class="line"><span class="comment">              x: 0.0</span></span><br><span class="line"><span class="comment">              y: 0.0</span></span><br><span class="line"><span class="comment">              theta: 0.0</span></span><br><span class="line"><span class="comment">              linear_velocity: 0.0</span></span><br><span class="line"><span class="comment">              angular_velocity: 0.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      发布话题：/t2/turtle1/cmd_vel</span></span><br><span class="line"><span class="comment">      发布消息：geometry_msgs/msg/Twist</span></span><br><span class="line"><span class="comment">              linear:</span></span><br><span class="line"><span class="comment">                x: 0.0</span></span><br><span class="line"><span class="comment">                y: 0.0</span></span><br><span class="line"><span class="comment">                z: 0.0</span></span><br><span class="line"><span class="comment">              angular:</span></span><br><span class="line"><span class="comment">                x: 0.0  翻滚</span></span><br><span class="line"><span class="comment">                y: 0.0  俯仰</span></span><br><span class="line"><span class="comment">                z: 0.0  左右转</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1 创建发布方</span></span><br><span class="line"><span class="comment">      3-2 创建订阅方(订阅乌龟1位姿，解析速度)</span></span><br><span class="line"><span class="comment">      3-3 订阅方回调函数处理速度，并生成发布控制乌龟2的指令</span></span><br><span class="line"><span class="comment">    4.调用spin函数,并传入节点对象指针;</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"geometry_msgs/msg/twist.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"turtlesim/msg/pose.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::placeholders::_1;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test01PubSub</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test01PubSub</span>():<span class="built_in">Node</span>(<span class="string">"test01_pub_sub_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"创建成功!"</span>);</span><br><span class="line">        <span class="comment">// 3-1 创建发布方</span></span><br><span class="line">        twist_pub_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_publisher</span>&lt;geometry_msgs::msg::Twist&gt;(<span class="string">"/t2/turtle1/cmd_vel"</span>,<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 3-2 创建订阅方(订阅乌龟1位姿，解析速度)</span></span><br><span class="line">        pose_sub_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_subscription</span>&lt;turtlesim::msg::Pose&gt;(<span class="string">"/turtle1/pose"</span>,<span class="number">10</span>,std::<span class="built_in">bind</span>(&amp;Test01PubSub::do_pose,<span class="keyword">this</span>,_1));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">do_pose</span><span class="params">(<span class="type">const</span> turtlesim::msg::Pose &amp; pose)</span></span>{</span><br><span class="line">      <span class="comment">// 处理速度，并生成发布控制乌龟2的指令</span></span><br><span class="line">      geometry_msgs::msg::Twist twist;</span><br><span class="line">      twist.linear.x = (pose.linear_velocity); <span class="comment">// 线速度不变</span></span><br><span class="line">      twist.angular.z = -(pose.angular_velocity); <span class="comment">// 角速度取反</span></span><br><span class="line">      twist_pub_-&gt;<span class="built_in">publish</span>(twist);</span><br><span class="line">    }</span><br><span class="line">    rclcpp::Publisher&lt;geometry_msgs::msg::Twist&gt;::SharedPtr twist_pub_;</span><br><span class="line">    rclcpp::Subscription&lt;turtlesim::msg::Pose&gt;::SharedPtr pose_sub_;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数,并传入节点类对象;</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;Test01PubSub&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>BUG描述：乌龟1后退时，乌龟2仍然前进</p>
<p>BUG原因：</p>
<ol>
<li>和乌龟位姿发布有关，当乌龟实际速度为负数时，位姿中的速度仍是正数；</li>
<li>发布的乌龟2的速度，与位姿中的线速度一致</li>
</ol>
<p>BUG修复：(修改源码)</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// p-&gt;linear_velocity = std::sqrt(lin_vel_x_ * lin_vel_x_ + lin_vel_y_ * lin_vel_y_);</span></span><br><span class="line">p-&gt;linear_velocity = lin_vel_x_;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="服务通信案例"><a href="#服务通信案例" class="headerlink" title="服务通信案例"></a>服务通信案例</h3><p>需求：在turtlesim_node节点的窗体中在指定位置生成一只新乌龟并可以输出两只乌龟之间的直线距离</p>
<p>需要关注的问题有两个：</p>
<ol>
<li>如何在指定位置生成一只新乌龟？</li>
<li>计算两只乌龟的距离应该使用何种通信模式又如何实现？</li>
</ol>
<p>问题1可以通过调用turtlesim_node内置的名称为/spawn的服务功能来实现新乌龟的创建；</p>
<p>问题2可以通过服务通信来实现，客户端发送新生成的乌龟的位姿到服务端，服务端根据该坐标以及原生乌龟的坐标计算距离并响应。当然如果使用服务通信，还需要自定义服务接口</p>
<p><strong>自定义接口消息</strong></p>
<p>功能包base_interfaces_demo的srv目录下，新建srv文件Distance.srv</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">float32 x</span><br><span class="line">float32 y</span><br><span class="line">float32 theta</span><br><span class="line">---</span><br><span class="line">float32 distance</span><br></pre></td></tr></tbody></table></figure>

<p>CMakeList.txt配置(其余部分之前配置过)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 为接口文件生成源码</span><br><span class="line">rosidl_generate_interfaces(${PROJECT_NAME}</span><br><span class="line">  "msg/Student.msg"</span><br><span class="line">  "srv/AddInts.srv"</span><br><span class="line">  "action/Progress.action"</span><br><span class="line">  "srv/Distance.srv" # 新增</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>检查是否配置成功；</p>
<p>先创建cpp和launch.py文件，配置功能包目录下的CMakeList，launch文件的配置因为用的是同一功能包不需要重复</p>
<p><strong>launch文件</strong></p>
<p>服务端：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_launch_description</span>():</span><br><span class="line">    <span class="comment"># 1. turtlesim node</span></span><br><span class="line">    t1 = Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>)</span><br><span class="line">    <span class="comment"># 2. 自定义的服务端</span></span><br><span class="line">    server = Node(package=<span class="string">"cpp07_exercise"</span>,executable=<span class="string">"test02_server"</span>)</span><br><span class="line">    <span class="keyword">return</span> LaunchDescription([t1,server])</span><br></pre></td></tr></tbody></table></figure>

<p>客户端：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"><span class="keyword">from</span> launch.actions <span class="keyword">import</span> ExecuteProcess</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_launch_description</span>():</span><br><span class="line">    <span class="comment"># 1. 指定位置生成一只新乌龟</span></span><br><span class="line">    x = <span class="number">6.0</span></span><br><span class="line">    y = <span class="number">9.0</span></span><br><span class="line">    theta = <span class="number">1.57</span></span><br><span class="line">    name = <span class="string">"t2"</span></span><br><span class="line">    spawn = ExecuteProcess(</span><br><span class="line">        cmd = [<span class="string">"ros2 service call /spawn turtlesim/srv/Spawn \"{'x': "</span></span><br><span class="line">               + <span class="built_in">str</span>(x) +<span class="string">",'y': "</span>+ <span class="built_in">str</span>(y) +</span><br><span class="line">               <span class="string">",'theta': "</span>+ <span class="built_in">str</span>(theta) +</span><br><span class="line">               <span class="string">",'name':'"</span>+ name +<span class="string">"'}\""</span>], <span class="comment"># 记得转义字符</span></span><br><span class="line">        output = <span class="string">"both"</span>,</span><br><span class="line">        shell = <span class="literal">True</span>  <span class="comment"># cmd当成终端指令执行</span></span><br><span class="line">    )</span><br><span class="line">    client = Node(package=<span class="string">"cpp07_exercise"</span>,</span><br><span class="line">                  executable=<span class="string">"test02_client"</span>,</span><br><span class="line">                  arguments=[<span class="built_in">str</span>(x),<span class="built_in">str</span>(y),<span class="built_in">str</span>(theta)])</span><br><span class="line">    <span class="comment"># 相当于ros2 run cpp07_exercise test02_client 6 9 0.0 --ros-args</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 调用客户端发送目标点坐标 </span></span><br><span class="line">    <span class="keyword">return</span> LaunchDescription([spawn,client])</span><br></pre></td></tr></tbody></table></figure>

<p><strong>服务端实现</strong></p>
<p>test02_server.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  需求:解析客户端提交的目标点坐标，获取原生乌龟坐标，计算二者距离并响应回客户端。</span></span><br><span class="line"><span class="comment">  步骤:</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建一个订阅方（原生乌龟位姿/turtlel/pose)；</span></span><br><span class="line"><span class="comment">      3-2.创建一个服务端；</span></span><br><span class="line"><span class="comment">      3-3.回调函数需要解析客户端数据并响应结果到客户端。</span></span><br><span class="line"><span class="comment">    4.调用spin函数,并传入节点对象指针;</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"turtlesim/msg/pose.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/srv/distance.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::placeholders::_1;</span><br><span class="line"><span class="keyword">using</span> std::placeholders::_2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> base_interfaces::srv::Distance;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test02Server</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test02Server</span>():<span class="built_in">Node</span>(<span class="string">"test02_server_node_cpp"</span>),<span class="built_in">x</span>(<span class="number">0.0</span>),<span class="built_in">y</span>(<span class="number">0.0</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"创建成功!"</span>);</span><br><span class="line">        pose_sub_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_subscription</span>&lt;turtlesim::msg::Pose&gt;(<span class="string">"/turtle1/pose"</span>,<span class="number">10</span>,std::<span class="built_in">bind</span>(&amp;Test02Server::pose_cb,<span class="keyword">this</span>,_1));</span><br><span class="line">        server_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_service</span>&lt;Distance&gt;(<span class="string">"distance"</span>,std::<span class="built_in">bind</span>(&amp;Test02Server::distance_cb,<span class="keyword">this</span>,_1,_2));</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    rclcpp::Subscription&lt;turtlesim::msg::Pose&gt;::SharedPtr pose_sub_;</span><br><span class="line">    rclcpp::Service&lt;Distance&gt;::SharedPtr server_;</span><br><span class="line">    <span class="type">float</span> x,y;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pose_cb</span><span class="params">(<span class="type">const</span> turtlesim::msg::Pose::SharedPtr pose)</span></span>{</span><br><span class="line">      x = pose-&gt;x;</span><br><span class="line">      y = pose-&gt;y;</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">distance_cb</span><span class="params">(<span class="type">const</span> Distance::Request::SharedPtr request,<span class="type">const</span> Distance::Response::SharedPtr response)</span></span>{</span><br><span class="line">      <span class="comment">// 解析目标点坐标</span></span><br><span class="line">      <span class="type">float</span> goal_x = request-&gt;x;</span><br><span class="line">      <span class="type">float</span> goal_y = request-&gt;y;</span><br><span class="line">      <span class="comment">// 计算距离</span></span><br><span class="line">      <span class="type">float</span> distance_x = goal_x - x;</span><br><span class="line">      <span class="type">float</span> distance_y = goal_y - y;</span><br><span class="line">      <span class="type">float</span> distance = std::<span class="built_in">sqrt</span>(distance_x * distance_x + distance_y * distance_y);</span><br><span class="line">      <span class="comment">// 设置进响应</span></span><br><span class="line">      response-&gt;distance = distance;</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"目标坐标:(%.2f,%.2f),距离:%.2f"</span>,goal_x,goal_y,response-&gt;distance);</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数,并传入节点类对象;</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;Test02Server&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><strong>客户端实现</strong></p>
<p>test02_client.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  需求：客户端需要提交目标点坐标，并解析响应结果。</span></span><br><span class="line"><span class="comment">  步骤：</span></span><br><span class="line"><span class="comment">    0.解析传入的数据</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.构造函数创建客户端;</span></span><br><span class="line"><span class="comment">      3-2.客户端需要连接服务端;</span></span><br><span class="line"><span class="comment">      3-3.发送请求数据。</span></span><br><span class="line"><span class="comment">    4.调用对象服务连接、发送请求、处理响应相关函数;</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/srv/distance.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> base_interfaces::srv::Distance;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test02Client</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test02Client</span>():<span class="built_in">Node</span>(<span class="string">"test02_client_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"创建成功!"</span>);</span><br><span class="line">        <span class="comment">// 3-1.构造函数创建客户端;</span></span><br><span class="line">        distance_client_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_client</span>&lt;Distance&gt;(<span class="string">"distance"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-2.客户端需要连接服务端;</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connect_server</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">while</span>(!distance_client_-&gt;<span class="built_in">wait_for_service</span>(<span class="number">1</span>s)){</span><br><span class="line">          <span class="keyword">if</span> (!rclcpp::<span class="built_in">ok</span>())</span><br><span class="line">          {</span><br><span class="line">          <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"客户端退出！"</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">          }</span><br><span class="line">          <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"服务连接中"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    rclcpp::Client&lt;Distance&gt;::<span class="function">FutureAndRequestId <span class="title">send_goal</span><span class="params">(<span class="type">float</span> x, <span class="type">float</span> y, <span class="type">float</span> theta)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="keyword">auto</span> request = std::<span class="built_in">make_shared</span>&lt;Distance::Request&gt;();</span><br><span class="line">      request-&gt;x = x;</span><br><span class="line">      request-&gt;y = y;</span><br><span class="line">      request-&gt;theta = theta;</span><br><span class="line">      <span class="keyword">return</span> distance_client_-&gt;<span class="built_in">async_send_request</span>(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    rclcpp::Client&lt;Distance&gt;::SharedPtr distance_client_;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">5</span>) <span class="comment">// 5是因为还有name，一共其实是4个参数</span></span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"请传入目标的位姿参数:(x,y,theta)"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用对象服务连接、处理响应相关函数</span></span><br><span class="line">  <span class="keyword">auto</span> client = std::<span class="built_in">make_shared</span>&lt;Test02Client&gt;();</span><br><span class="line">  <span class="comment">// 解析提交的参数</span></span><br><span class="line">  <span class="type">float</span> goal_x = <span class="built_in">atoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line">  <span class="type">float</span> goal_y = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line">  <span class="type">float</span> goal_theta = <span class="built_in">atoi</span>(argv[<span class="number">3</span>]);</span><br><span class="line">  <span class="type">bool</span> flag = client-&gt;<span class="built_in">connect_server</span>();</span><br><span class="line">  <span class="keyword">if</span>(!flag)</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"服务连接失败!"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 发送请求</span></span><br><span class="line">  <span class="keyword">auto</span> distance_future = client-&gt;<span class="built_in">send_goal</span>(goal_x,goal_y,goal_theta);</span><br><span class="line">  <span class="comment">// 判断响应状态</span></span><br><span class="line">  <span class="keyword">if</span>(rclcpp::<span class="built_in">spin_until_future_complete</span>(client,distance_future)==rclcpp::FutureReturnCode::SUCCESS)</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(client-&gt;<span class="built_in">get_logger</span>(),<span class="string">"两只乌龟相距%.2f米。"</span>,distance_future.<span class="built_in">get</span>()-&gt;distance);</span><br><span class="line">  } <span class="keyword">else</span>{</span><br><span class="line">    <span class="built_in">RCLCPP_ERROR</span>(client-&gt;<span class="built_in">get_logger</span>(),<span class="string">"获取距离服务失败!"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="动作通信案例"><a href="#动作通信案例" class="headerlink" title="动作通信案例"></a>动作通信案例</h3><p>需求：处理请求发送的目标点，控制乌龟向该目标点运动，并连续反馈乌龟与目标点之间的剩余距离</p>
<p>在上述案例与服务通信案例类似，需要关注控制原生乌龟向目标乌龟运动并连续反馈剩余距离应该使用何种通信模式又如何实现？</p>
<p>思路：可以通过动作通信来实现，动作客户端发送目标信息到动作服务端，服务端根据该坐标以及原生乌龟的坐标计计算出二者距离，计算速度并控制原生乌龟运动。当然如果使用动作通信，还需要自定义动作接口。</p>
<p><strong>动作接口文件</strong></p>
<p>功能包base_interfaces_demo的action目录下，新建action文件Nav.action</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">float32 goal_x</span><br><span class="line">float32 goal_y</span><br><span class="line">float32 goal_theta</span><br><span class="line">---</span><br><span class="line">float32 turtle_x</span><br><span class="line">float32 turtle_y</span><br><span class="line">float32 turtle_theta</span><br><span class="line">---</span><br><span class="line">float32 distance</span><br></pre></td></tr></tbody></table></figure>

<p>编辑CMakeList(其余之前配置过)</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 为接口文件生成源码</span><br><span class="line">rosidl_generate_interfaces(${PROJECT_NAME}</span><br><span class="line">  "msg/Student.msg"</span><br><span class="line">  "srv/AddInts.srv"</span><br><span class="line">  "srv/Distance.srv"</span><br><span class="line">  "action/Progress.action"</span><br><span class="line">  "action/Nav.action" #新增</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p><strong>launch文件</strong></p>
<p>launch和服务通信的基本相同，复制内容修改节点即可</p>
<p>服务端：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_launch_description</span>():</span><br><span class="line">    <span class="comment"># 1. turtlesim node</span></span><br><span class="line">    t1 = Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>)</span><br><span class="line">    <span class="comment"># 2. 自定义的服务端</span></span><br><span class="line">    server = Node(package=<span class="string">"cpp07_exercise"</span>,executable=<span class="string">"test03_action_server"</span>)</span><br><span class="line">    <span class="keyword">return</span> LaunchDescription([t1,server])</span><br></pre></td></tr></tbody></table></figure>

<p>客户端：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"><span class="keyword">from</span> launch.actions <span class="keyword">import</span> ExecuteProcess</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_launch_description</span>():</span><br><span class="line">    x = <span class="number">6.0</span></span><br><span class="line">    y = <span class="number">9.0</span></span><br><span class="line">    theta = <span class="number">1.57</span></span><br><span class="line">    client = Node(package=<span class="string">"cpp07_exercise"</span>,</span><br><span class="line">                  executable=<span class="string">"test03_action_client"</span>,</span><br><span class="line">                  arguments=[<span class="built_in">str</span>(x),<span class="built_in">str</span>(y),<span class="built_in">str</span>(theta)])</span><br><span class="line">    <span class="comment"># 相当于ros2 run cpp07_exercise test02_client 6 9 0.0 --ros-args</span></span><br><span class="line">    <span class="comment"># 调用客户端发送目标点坐标 </span></span><br><span class="line">    <span class="keyword">return</span> LaunchDescription([client])</span><br></pre></td></tr></tbody></table></figure>

<p><strong>动作服务端</strong></p>
<p>按住ctrl  点击create_server→Server</p>
<p>根据模板编写action服务端的创建代码</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> GoalCallback = std::function&lt;<span class="built_in">GoalResponse</span>(</span><br><span class="line">      <span class="type">const</span> GoalUUID &amp;, std::shared_ptr&lt;<span class="type">const</span> <span class="keyword">typename</span> ActionT::Goal&gt;)&gt;;</span><br><span class="line"><span class="keyword">using</span> CancelCallback = std::function&lt;<span class="built_in">CancelResponse</span>(std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;</span><br><span class="line"><span class="keyword">using</span> AcceptedCallback = std::function&lt;<span class="built_in">void</span> (std::shared_ptr&lt;ServerGoalHandle&lt;ActionT&gt;&gt;)&gt;;</span><br></pre></td></tr></tbody></table></figure>

<p>test03_action_server.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  需求:处理客户端发送的控制乌龟向目标点运动，且要连续反馈剩余距离</span></span><br><span class="line"><span class="comment">  步骤:</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建原生乌龟位姿订阅方，回调函数中获取乌龟位姿；</span></span><br><span class="line"><span class="comment">      3-2.创建原生乌龟速度发布方；</span></span><br><span class="line"><span class="comment">      3-3.创建动作服务端；</span></span><br><span class="line"><span class="comment">      3-4.解析动作客户端发送的请求；</span></span><br><span class="line"><span class="comment">      3-5.处理动作客户端发送的取消请求；</span></span><br><span class="line"><span class="comment">      3-6.创建新线程处理主逻辑请求；</span></span><br><span class="line"><span class="comment">      3-7.新线程产生连续反馈并响应最终结果。</span></span><br><span class="line"><span class="comment">    4.调用spin函数,并传入节点对象指针;</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"turtlesim/msg/pose.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"geometry_msgs/msg/twist.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp_action/rclcpp_action.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/action/nav.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;</span><br><span class="line"><span class="keyword">using</span> base_interfaces::action::Nav;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test03ActionServer</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test03ActionServer</span>():<span class="built_in">Node</span>(<span class="string">"test03_action_server_node_cpp"</span>),<span class="built_in">x</span>(<span class="number">0.0</span>),<span class="built_in">y</span>(<span class="number">0.0</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"动作服务端创建成功!"</span>);</span><br><span class="line">        <span class="comment">// 3-1.创建原生乌龟位姿订阅方，回调函数中获取乌龟位姿</span></span><br><span class="line">        pose_sub_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_subscription</span>&lt;turtlesim::msg::Pose&gt;(<span class="string">"/turtle1/pose"</span>,<span class="number">10</span>,std::<span class="built_in">bind</span>(&amp;Test03ActionServer::pose_cb,<span class="keyword">this</span>,_1));</span><br><span class="line">        <span class="comment">// 3-2.创建原生乌龟速度发布方；</span></span><br><span class="line">        cmd_vel_pub_ = <span class="keyword">this</span>-&gt;<span class="built_in">create_publisher</span>&lt;geometry_msgs::msg::Twist&gt;(<span class="string">"/turtle1/cmd_vel"</span>,<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 3-3.创建动作服务端；</span></span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">        (NodeT node, </span></span><br><span class="line"><span class="comment">        const std::string &amp;name,</span></span><br><span class="line"><span class="comment">        rclcpp_action::Server&lt;ActionT&gt;::GoalCallback handle_goal, </span></span><br><span class="line"><span class="comment">        rclcpp_action::Server&lt;ActionT&gt;::CancelCallback handle_cancel, </span></span><br><span class="line"><span class="comment">        rclcpp_action::Server&lt;ActionT&gt;::AcceptedCallback handle_accepted</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        action_server_ = rclcpp_action::<span class="built_in">create_server</span>&lt;Nav&gt;(</span><br><span class="line">          <span class="keyword">this</span>,</span><br><span class="line">          <span class="string">"nav"</span>,</span><br><span class="line">          std::<span class="built_in">bind</span>(&amp;Test03ActionServer::handle_goal,<span class="keyword">this</span>,_1,_2),</span><br><span class="line">          std::<span class="built_in">bind</span>(&amp;Test03ActionServer::handle_cancel,<span class="keyword">this</span>,_1),</span><br><span class="line">          std::<span class="built_in">bind</span>(&amp;Test03ActionServer::handle_accepted,<span class="keyword">this</span>,_1));</span><br><span class="line">          <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"动作服务端创建，等待请求..."</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    rclcpp::Subscription&lt;turtlesim::msg::Pose&gt;::SharedPtr pose_sub_;</span><br><span class="line">    rclcpp::Publisher&lt;geometry_msgs::msg::Twist&gt;::SharedPtr cmd_vel_pub_;</span><br><span class="line">    rclcpp_action::Server&lt;Nav&gt;::SharedPtr action_server_;</span><br><span class="line">    <span class="type">float</span> x,y;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pose_cb</span><span class="params">(<span class="type">const</span> turtlesim::msg::Pose::SharedPtr pose)</span></span>{</span><br><span class="line">      x = pose-&gt;x;</span><br><span class="line">      y = pose-&gt;y;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-4.解析动作客户端发送的请求；</span></span><br><span class="line">    <span class="function">rclcpp_action::GoalResponse <span class="title">handle_goal</span><span class="params">(<span class="type">const</span> rclcpp_action::GoalUUID &amp; uuid, std::shared_ptr&lt;<span class="type">const</span> Nav::Goal&gt; goal)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      (<span class="type">void</span>)uuid; <span class="comment">// 标识目前没用上,避免警告</span></span><br><span class="line">      <span class="comment">// 判断目标的x,y值是否超出框</span></span><br><span class="line">      <span class="type">float</span> goal_x = goal-&gt;goal_x;</span><br><span class="line">      <span class="type">float</span> goal_y = goal-&gt;goal_y;</span><br><span class="line">      <span class="keyword">if</span>(goal_x &lt; <span class="number">0</span> || goal_x &gt; <span class="number">11.08</span> || goal_y &lt; <span class="number">0</span> || goal_y &gt; <span class="number">11.08</span>)</span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"无效目标值!"</span>);</span><br><span class="line">        <span class="keyword">return</span> rclcpp_action::GoalResponse::REJECT;</span><br><span class="line">      }</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"目标点合法!"</span>);</span><br><span class="line">      <span class="keyword">return</span> rclcpp_action::GoalResponse::ACCEPT_AND_EXECUTE;</span><br><span class="line">    }</span><br><span class="line">    <span class="function">rclcpp_action::CancelResponse <span class="title">handle_cancel</span><span class="params">(std::shared_ptr&lt;rclcpp_action::ServerGoalHandle&lt;Nav&gt;&gt; goal_handle)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      (<span class="type">void</span>)goal_handle;</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"接收到取消请求!"</span>);</span><br><span class="line">      <span class="keyword">return</span> rclcpp_action::CancelResponse::ACCEPT;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 主逻辑处理</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">execute</span><span class="params">(std::shared_ptr&lt;rclcpp_action::ServerGoalHandle&lt;Nav&gt;&gt; goal_handle)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"开始执行任务......"</span>);</span><br><span class="line">      <span class="comment">// 创建连续反馈对象指针；</span></span><br><span class="line">      <span class="keyword">auto</span> feedback = std::<span class="built_in">make_shared</span>&lt;Nav::Feedback&gt;();</span><br><span class="line">      <span class="comment">// 创建最终结果对象指针；</span></span><br><span class="line">      <span class="keyword">auto</span> result = std::<span class="built_in">make_shared</span>&lt;Nav::Result&gt;();</span><br><span class="line">      <span class="comment">// 生成连续反馈</span></span><br><span class="line">      <span class="function">rclcpp::Rate <span class="title">rate</span><span class="params">(<span class="number">1.0</span>)</span></span>;</span><br><span class="line">      <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">      {</span><br><span class="line">        <span class="comment">// 任务执行中，关于客户端发送取消请求的处理；</span></span><br><span class="line">        <span class="keyword">if</span>(goal_handle-&gt;<span class="built_in">is_canceling</span>()){</span><br><span class="line">          goal_handle-&gt;<span class="built_in">canceled</span>(result);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 解析目标点坐标与原生乌龟位姿数据；</span></span><br><span class="line">        <span class="type">float</span> goal_x = goal_handle-&gt;<span class="built_in">get_goal</span>()-&gt;goal_x;</span><br><span class="line">        <span class="type">float</span> goal_y = goal_handle-&gt;<span class="built_in">get_goal</span>()-&gt;goal_y;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算剩余距离并发布</span></span><br><span class="line">        <span class="type">float</span> distance_x = goal_x - x;</span><br><span class="line">        <span class="type">float</span> distance_y = goal_y - y;</span><br><span class="line">        <span class="type">float</span> distance = std::<span class="built_in">sqrt</span>(distance_x * distance_x + distance_y * distance_y);</span><br><span class="line">        feedback-&gt;distance = distance;</span><br><span class="line">        goal_handle-&gt;<span class="built_in">publish_feedback</span>(feedback);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算速度指令并发布</span></span><br><span class="line">        <span class="type">float</span> scale = <span class="number">0.5</span>;</span><br><span class="line">        geometry_msgs::msg::Twist twist;</span><br><span class="line">        twist.linear.x = scale * distance_x;</span><br><span class="line">        twist.linear.y = scale * distance_y;</span><br><span class="line">        cmd_vel_pub_-&gt;<span class="built_in">publish</span>(twist);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环结束条件</span></span><br><span class="line">        <span class="keyword">if</span>(distance &lt; <span class="number">0.05</span>)</span><br><span class="line">        {</span><br><span class="line">          <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"导航至目标点！"</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        rate.<span class="built_in">sleep</span>();</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// 生成最终响应</span></span><br><span class="line">      <span class="keyword">if</span>(rclcpp::<span class="built_in">ok</span>()){</span><br><span class="line">        result-&gt;turtle_x = x;</span><br><span class="line">        result-&gt;turtle_y = y;</span><br><span class="line">        goal_handle-&gt;<span class="built_in">succeed</span>(result);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handle_accepted</span><span class="params">(std::shared_ptr&lt;rclcpp_action::ServerGoalHandle&lt;Nav&gt;&gt; goal_handle)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      <span class="comment">// 新建线程处理耗时的主逻辑</span></span><br><span class="line">      std::thread{std::<span class="built_in">bind</span>(&amp;Test03ActionServer::execute,<span class="keyword">this</span>,_1),goal_handle}.<span class="built_in">detach</span>();</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.调用spin函数,并传入节点类对象;</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(std::<span class="built_in">make_shared</span>&lt;Test03ActionServer&gt;()); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>test03_action_client.cpp</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  需求:向动作服务端发送目标点数据，并处理响应数据。</span></span><br><span class="line"><span class="comment">  步骤:</span></span><br><span class="line"><span class="comment">    0.解析launch文件传入的参数</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建动作客户端；</span></span><br><span class="line"><span class="comment">      3-2.发送请求数据，并处理服务端响应；</span></span><br><span class="line"><span class="comment">      3-3.处理目标响应；</span></span><br><span class="line"><span class="comment">      3-4.处理响应的连续反馈；</span></span><br><span class="line"><span class="comment">      3-5.处理最终响应。</span></span><br><span class="line"><span class="comment">    4.调用spin函数,并传入节点对象指针;</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp_action/rclcpp_action.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"base_interfaces/action/nav.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::placeholders;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"><span class="keyword">using</span> base_interfaces::action::Nav;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test03ActionClient</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test03ActionClient</span>():<span class="built_in">Node</span>(<span class="string">"test03_action_client_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"动作客户端创建成功!"</span>);</span><br><span class="line">      <span class="comment">// 3-1.创建动作客户端；</span></span><br><span class="line">      client_ = rclcpp_action::<span class="built_in">create_client</span>&lt;Nav&gt;(<span class="keyword">this</span>,<span class="string">"nav"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-2.发送请求数据，并处理服务端响应；</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">send_goal</span><span class="params">(<span class="type">float</span> x, <span class="type">float</span> y, <span class="type">float</span> theta)</span></span>{</span><br><span class="line">      <span class="comment">// 连接服务端</span></span><br><span class="line">      <span class="keyword">if</span>(!client_ -&gt; <span class="built_in">wait_for_action_server</span>(<span class="number">10</span>s))</span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"连接超时!"</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">// 组织发送数据</span></span><br><span class="line">      Nav::Goal goal;</span><br><span class="line">      goal.goal_x = x;</span><br><span class="line">      goal.goal_y = y;</span><br><span class="line">      goal.goal_theta = theta;</span><br><span class="line">      rclcpp_action::Client&lt;Nav&gt;::SendGoalOptions options;</span><br><span class="line">      options.goal_response_callback = std::<span class="built_in">bind</span>(&amp;Test03ActionClient::goal_response_callback,<span class="keyword">this</span>,_1);</span><br><span class="line">      options.feedback_callback = std::<span class="built_in">bind</span>(&amp;Test03ActionClient::feedback_callback,<span class="keyword">this</span>,_1,_2);</span><br><span class="line">      options.result_callback = std::<span class="built_in">bind</span>(&amp;Test03ActionClient::result_callback,<span class="keyword">this</span>,_1);</span><br><span class="line">      client_-&gt;<span class="built_in">async_send_goal</span>(goal,options);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>: </span><br><span class="line">    rclcpp_action::Client&lt;Nav&gt;::SharedPtr client_;</span><br><span class="line">    <span class="comment">// 将UUID转换为可读字符串</span></span><br><span class="line">    <span class="function">std::string <span class="title">goal_uuid_to_string</span><span class="params">(<span class="type">const</span> rclcpp_action::GoalUUID&amp; uuid)</span> </span>{</span><br><span class="line">      std::stringstream ss;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">auto</span> byte : uuid) {</span><br><span class="line">          ss &lt;&lt; std::hex &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; std::<span class="built_in">setfill</span>(<span class="string">'0'</span>) &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(byte);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> ss.<span class="built_in">str</span>();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-3.处理目标响应；</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">goal_response_callback</span><span class="params">(rclcpp_action::ClientGoalHandle&lt;Nav&gt;::SharedPtr goal_handle)</span></span>{</span><br><span class="line">      <span class="keyword">if</span>(!goal_handle){</span><br><span class="line">        <span class="built_in">RCLCPP_ERROR</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"目标请求被服务端拒绝!"</span>);</span><br><span class="line">        rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">      } <span class="keyword">else</span>{</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"目标处理中!目标ID: %s"</span>,<span class="built_in">goal_uuid_to_string</span>(goal_handle-&gt;<span class="built_in">get_goal_id</span>()).<span class="built_in">c_str</span>());</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-4.处理响应的连续反馈；</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">feedback_callback</span><span class="params">(rclcpp_action::ClientGoalHandle&lt;Nav&gt;::SharedPtr goal_handle, <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> Nav::Feedback&gt; feedback)</span></span>{</span><br><span class="line">      (<span class="type">void</span>)goal_handle;</span><br><span class="line">      <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"剩余距离:%.2f"</span>,feedback-&gt;distance);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-5.处理最终响应。</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">result_callback</span><span class="params">(<span class="type">const</span> rclcpp_action::ClientGoalHandle&lt;Nav&gt;::WrappedResult &amp; result)</span></span>{</span><br><span class="line">      <span class="comment">// 通过状态码判断结果状态</span></span><br><span class="line">      <span class="keyword">if</span>(result.code == rclcpp_action::ResultCode::SUCCEEDED)</span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),</span><br><span class="line">          <span class="string">"乌龟最终坐标:(%.2f,%.2f),航向:%.2f"</span>,</span><br><span class="line">          result.result-&gt;turtle_x,</span><br><span class="line">          result.result-&gt;turtle_y,</span><br><span class="line">          result.result-&gt;turtle_theta);</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span>(result.code == rclcpp_action::ResultCode::ABORTED)</span><br><span class="line">      {</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"任务被中止!"</span>);</span><br><span class="line"></span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span>(result.code == rclcpp_action::ResultCode::CANCELED){</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"任务被取消!"</span>);</span><br><span class="line"></span><br><span class="line">      } <span class="keyword">else</span>{</span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"未知异常!"</span>);</span><br><span class="line">      }</span><br><span class="line">      rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">5</span>)</span><br><span class="line">  {</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"请传入合法的目标位姿参数:(x,y,theta)"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 不能直接spin</span></span><br><span class="line">  <span class="keyword">auto</span> client = std::<span class="built_in">make_shared</span>&lt;Test03ActionClient&gt;();</span><br><span class="line">  client-&gt;<span class="built_in">send_goal</span>(<span class="built_in">atof</span>(argv[<span class="number">1</span>]),<span class="built_in">atof</span>(argv[<span class="number">2</span>]),<span class="built_in">atof</span>(argv[<span class="number">3</span>]));</span><br><span class="line">  <span class="comment">// 4.调用spin函数,并传入节点类对象;</span></span><br><span class="line">  rclcpp::<span class="built_in">spin</span>(client); </span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="参数服务案例分析"><a href="#参数服务案例分析" class="headerlink" title="参数服务案例分析"></a>参数服务案例分析</h3><p>需求：动态修改乌龟窗口的背景颜色</p>
<p>配置自配</p>
<p><strong>launch文件</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_launch_description</span>():</span><br><span class="line">    t = Node(package=<span class="string">"turtlesim"</span>,executable=<span class="string">"turtlesim_node"</span>)</span><br><span class="line">    param = Node(package=<span class="string">"cpp07_exercise"</span>,executable=<span class="string">"test04_param"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> LaunchDescription([t,param])</span><br></pre></td></tr></tbody></table></figure>

<p>test04_param.cpp</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  需求: 修改turtlesim_node的背景颜色</span></span><br><span class="line"><span class="comment">  步骤:</span></span><br><span class="line"><span class="comment">    1.包含头文件；</span></span><br><span class="line"><span class="comment">    2.初始化 ROS2 客户端；</span></span><br><span class="line"><span class="comment">    3.定义节点类；</span></span><br><span class="line"><span class="comment">      3-1.创建参数客户端；</span></span><br><span class="line"><span class="comment">      3-2.连接参数服务端；</span></span><br><span class="line"><span class="comment">      3-3.更新参数。</span></span><br><span class="line"><span class="comment">    4.创建对象指针,并调用其函数;</span></span><br><span class="line"><span class="comment">    5.释放资源。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.包含头文件；</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono_literals;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.自定义节点类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test04Param</span>: <span class="keyword">public</span> rclcpp::Node{ </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test04Param</span>():<span class="built_in">Node</span>(<span class="string">"test04_param_node_cpp"</span>){  <span class="comment">// 节点名称一般小写</span></span><br><span class="line">        <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"参数服务器创建成功!"</span>);</span><br><span class="line">        <span class="comment">// 3-1.创建参数客户端</span></span><br><span class="line">        client_ = std::<span class="built_in">make_shared</span>&lt;rclcpp::SyncParametersClient&gt;(<span class="keyword">this</span>,<span class="string">"/turtlesim"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-2.连接参数服务端</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">connect_server</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="keyword">while</span>(!client_-&gt;<span class="built_in">wait_for_service</span>(<span class="number">5</span>s)){</span><br><span class="line">            <span class="keyword">if</span>(!rclcpp::<span class="built_in">ok</span>())</span><br><span class="line">            {</span><br><span class="line">              <span class="built_in">RCLCPP_INFO</span>(rclcpp::<span class="built_in">get_logger</span>(<span class="string">"rclcpp"</span>),<span class="string">"强制退出！"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"服务连接中..."</span>);</span><br><span class="line">        }</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 3-3.更新参数</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update_param</span><span class="params">()</span></span>{</span><br><span class="line">        <span class="comment">// 背景色渐变修改</span></span><br><span class="line">        <span class="comment">// background_r[0,255]</span></span><br><span class="line">        <span class="comment">// 获取参数</span></span><br><span class="line">        red = client_-&gt;<span class="built_in">get_parameter</span>&lt;<span class="type">int32_t</span>&gt;(<span class="string">"background_r"</span>);</span><br><span class="line">        <span class="function">rclcpp::Rate <span class="title">rate</span><span class="params">(<span class="number">30.0</span>)</span></span>;</span><br><span class="line">        <span class="comment">// 编写循环，修改参数</span></span><br><span class="line">        <span class="type">int</span> count = red;</span><br><span class="line">        <span class="keyword">while</span>(rclcpp::<span class="built_in">ok</span>())</span><br><span class="line">        {</span><br><span class="line">          <span class="comment">/* </span></span><br><span class="line"><span class="comment">            计数器在[0,255)递增，[255,510]递减，大于等于510时归0</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">          count &lt; <span class="number">255</span> ? red +=  <span class="number">5</span> : red -= <span class="number">5</span>;</span><br><span class="line">          count += <span class="number">5</span>;</span><br><span class="line">          <span class="keyword">if</span>(count&gt;=<span class="number">510</span>) count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 修改服务器参数</span></span><br><span class="line">          client_-&gt;<span class="built_in">set_parameters</span>({rclcpp::<span class="built_in">Parameter</span>(<span class="string">"background_r"</span>,red)});</span><br><span class="line">          <span class="built_in">RCLCPP_INFO</span>(<span class="keyword">this</span>-&gt;<span class="built_in">get_logger</span>(),<span class="string">"red = %d"</span>, red);</span><br><span class="line">          rate.<span class="built_in">sleep</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    rclcpp::SyncParametersClient::SharedPtr client_;</span><br><span class="line">    <span class="type">int32_t</span> red;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> ** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="comment">// 2.初始化 ROS2 客户端；</span></span><br><span class="line">  rclcpp::<span class="built_in">init</span>(argc,argv);</span><br><span class="line">  <span class="comment">// 4.创建对象指针,并调用其函数</span></span><br><span class="line">  <span class="keyword">auto</span> client = std::<span class="built_in">make_shared</span>&lt;Test04Param&gt;();</span><br><span class="line">  <span class="comment">// 判断连接状态</span></span><br><span class="line">  <span class="keyword">if</span>(!client-&gt;<span class="built_in">connect_server</span>())</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line">  client-&gt;<span class="built_in">update_param</span>();</span><br><span class="line">  <span class="comment">// 5.释放资源。</span></span><br><span class="line">  rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://yhblogs.cn">今天睡够了吗</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://yhblogs.cn/posts/3894864178.html">http://yhblogs.cn/posts/3894864178.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yhblogs.cn" target="_blank">がんばろう</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%F0%9F%A4%96ROS/">🤖ROS</a></div><div class="post_share"><div class="social-share" data-image="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/wallhaven-5g22q5_1920x1080_compressed.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2426107671.html" title="C++职工管理系统"><img class="cover" src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/wallhaven-zywe5j_1920x1080_compressed.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">C++职工管理系统</div></div></a></div><div class="next-post pull-right"><a href="/posts/2715330630.html" title="秦皇岛出游"><img class="cover" src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/wallhaven-4996q1_compressed.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">秦皇岛出游</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/626062709.html" title="ROS基础知识"><img class="cover" src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/ros-logo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-19</div><div class="title">ROS基础知识</div></div></a></div><div><a href="/posts/3254549402.html" title="ROS机器人系统"><img class="cover" src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/wallhaven-1q83qg.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-10</div><div class="title">ROS机器人系统</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/b_2a1aef95f351a5f7ef72eb81e6838fd6.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info__name">今天睡够了吗</div><div class="author-info__description">相遇是最小单位的奇迹</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">75</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">15</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/202206071549233.webp" target="_blank" title="QQ"><i class="iconfont icon-QQ"></i></a><a class="social-icon" href="https://wuyaohui06022.oss-cn-chengdu.aliyuncs.com/blogwebp/202206071549234.webp" target="_blank" title="微信"><i class="iconfont icon-weixin"></i></a><a class="social-icon" href="https://space.bilibili.com/277953459?spm_id_from=333.1007.0.0" target="_blank" title="bilibili"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://github.com/YaoHui-Wu06022" target="_blank" title="Github"><i class="iconfont icon-GitHub"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">保持理智，相信明天</div><div class="twopeople"><div class="twopeople"><div class="container" style="height:200px;"><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div> <script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople1.js"></script> <script src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/zdog.dist.js"></script> <script id="rendered-js" src="https://cdn.jsdelivr.net/gh/Justlovesmile/CDN/js/twopeople.js"></script> <style>.twopeople{margin:0;align-items:center;justify-content:center;text-align:center}canvas{display:block;margin:0 auto;cursor:move}</style></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.</span> <span class="toc-text">模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROS2%E6%A6%82%E8%BF%B0%E4%B8%8E%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">ROS2概述与环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ROS2%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">ROS2简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ROS2%E5%AF%B9%E6%AF%94ROS"><span class="toc-number">2.2.</span> <span class="toc-text">ROS2对比ROS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ROS2%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.</span> <span class="toc-text">ROS2安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ROS2%E9%9B%86%E6%88%90%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83"><span class="toc-number">2.4.</span> <span class="toc-text">ROS2集成开发环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%88%E7%AB%AF"><span class="toc-number">2.4.1.</span> <span class="toc-text">终端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VScode"><span class="toc-number">2.4.2.</span> <span class="toc-text">VScode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#git"><span class="toc-number">2.4.3.</span> <span class="toc-text">git</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4"><span class="toc-number">2.4.4.</span> <span class="toc-text">操作命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ROS2%E4%BD%93%E7%B3%BB%E6%A1%86%E6%9E%B6"><span class="toc-number">2.5.</span> <span class="toc-text">ROS2体系框架</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ROS2%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.5.1.</span> <span class="toc-text">ROS2文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">2.5.1.1.</span> <span class="toc-text">源文件说明</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">配置文件说明</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ROS2%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97"><span class="toc-number">2.5.2.</span> <span class="toc-text">ROS2核心模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ROS2%E6%8A%80%E6%9C%AF%E6%94%AF%E6%8C%81"><span class="toc-number">2.5.3.</span> <span class="toc-text">ROS2技术支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ROS2%E5%BA%94%E7%94%A8%E6%96%B9%E5%90%91"><span class="toc-number">2.5.4.</span> <span class="toc-text">ROS2应用方向</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROS2%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E6%A0%B8%E5%BF%83"><span class="toc-number">3.</span> <span class="toc-text">ROS2通信机制核心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.</span> <span class="toc-text">通信机制简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">3.2.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%9D%E9%A2%98%E9%80%9A%E4%BF%A1"><span class="toc-number">3.3.</span> <span class="toc-text">话题通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E9%9C%80%E6%B1%82"><span class="toc-number">3.3.1.</span> <span class="toc-text">案例需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F%E6%B6%88%E6%81%AF"><span class="toc-number">3.3.2.</span> <span class="toc-text">原生消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%8F%A3%E6%B6%88%E6%81%AF"><span class="toc-number">3.3.3.</span> <span class="toc-text">配置接口消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B6%88%E6%81%AF"><span class="toc-number">3.3.4.</span> <span class="toc-text">自定义消息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1"><span class="toc-number">3.4.</span> <span class="toc-text">服务通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E9%9C%80%E6%B1%82-1"><span class="toc-number">3.4.1.</span> <span class="toc-text">案例需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%8F%A3%E6%B6%88%E6%81%AF-1"><span class="toc-number">3.4.2.</span> <span class="toc-text">配置接口消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.4.3.</span> <span class="toc-text">案例实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E4%BD%9C%E9%80%9A%E4%BF%A1"><span class="toc-number">3.5.</span> <span class="toc-text">动作通信</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E9%9C%80%E6%B1%82-2"><span class="toc-number">3.5.1.</span> <span class="toc-text">案例需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8E%A5%E5%8F%A3%E6%B6%88%E6%81%AF-2"><span class="toc-number">3.5.2.</span> <span class="toc-text">配置接口消息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0-1"><span class="toc-number">3.5.3.</span> <span class="toc-text">案例实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.6.</span> <span class="toc-text">参数服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E9%9C%80%E6%B1%82-3"><span class="toc-number">3.6.1.</span> <span class="toc-text">案例需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.6.2.</span> <span class="toc-text">参数数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0-2"><span class="toc-number">3.6.3.</span> <span class="toc-text">案例实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E8%8A%82"><span class="toc-number">3.7.</span> <span class="toc-text">本章小节</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROS2%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E8%A1%A5%E5%85%85"><span class="toc-number">4.</span> <span class="toc-text">ROS2通信机制补充</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">4.1.</span> <span class="toc-text">分布式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%A9%BA%E9%97%B4%E8%A6%86%E7%9B%96"><span class="toc-number">4.2.</span> <span class="toc-text">工作空间覆盖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%83%E5%8A%9F%E8%83%BD%E5%8C%85"><span class="toc-number">4.3.</span> <span class="toc-text">元功能包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8A%82%E7%82%B9%E9%87%8D%E5%90%8D"><span class="toc-number">4.4.</span> <span class="toc-text">节点重名</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#run2-run"><span class="toc-number">4.4.1.</span> <span class="toc-text">run2 run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#launch"><span class="toc-number">4.4.2.</span> <span class="toc-text">launch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81"><span class="toc-number">4.4.3.</span> <span class="toc-text">编码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%9D%E9%A2%98%E9%87%8D%E5%90%8D"><span class="toc-number">4.5.</span> <span class="toc-text">话题重名</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#run2-run-1"><span class="toc-number">4.5.1.</span> <span class="toc-text">run2 run</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#launch-1"><span class="toc-number">4.5.2.</span> <span class="toc-text">launch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81-1"><span class="toc-number">4.5.3.</span> <span class="toc-text">编码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%9B%B8%E5%85%B3API"><span class="toc-number">4.6.</span> <span class="toc-text">时间相关API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Rate"><span class="toc-number">4.6.1.</span> <span class="toc-text">Rate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Time"><span class="toc-number">4.6.2.</span> <span class="toc-text">Time</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Duration"><span class="toc-number">4.6.3.</span> <span class="toc-text">Duration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E7%AE%97"><span class="toc-number">4.6.4.</span> <span class="toc-text">运算</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%B7%A5%E5%85%B7"><span class="toc-number">4.7.</span> <span class="toc-text">通信机制工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%B7%A5%E5%85%B7"><span class="toc-number">4.7.1.</span> <span class="toc-text">命令工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rqt%E5%B7%A5%E5%85%B7%E7%AE%B1"><span class="toc-number">4.7.2.</span> <span class="toc-text">rqt工具箱</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROS2%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%AE%9E%E6%93%8D"><span class="toc-number">5.</span> <span class="toc-text">ROS2通信机制实操</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%9D%E9%A2%98%E9%80%9A%E4%BF%A1%E6%A1%88%E4%BE%8B"><span class="toc-number">5.1.</span> <span class="toc-text">话题通信案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%80%9A%E4%BF%A1%E6%A1%88%E4%BE%8B"><span class="toc-number">5.2.</span> <span class="toc-text">服务通信案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E4%BD%9C%E9%80%9A%E4%BF%A1%E6%A1%88%E4%BE%8B"><span class="toc-number">5.3.</span> <span class="toc-text">动作通信案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E6%9C%8D%E5%8A%A1%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">5.4.</span> <span class="toc-text">参数服务案例分析</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">©2022 - 2025 By 今天睡够了吗</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">You must always have faith in who you are！</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"></div><div id="rightside-config-show"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-heart.min.js" async="async" mobile="false"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>